<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.loli.net/css?family=Courier+Prime:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.dytttf.com","root":"/","images":"/images","scheme":"Gemini","version":"8.7.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"utterances","storage":true,"lazyload":false,"nav":null,"activeClass":"utterances"},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>
<meta name="description" content="https:&#x2F;&#x2F;github.com&#x2F;dytttf">
<meta property="og:type" content="website">
<meta property="og:title" content="Dytttf&#39;s Space">
<meta property="og:url" content="http://www.dytttf.com/">
<meta property="og:site_name" content="Dytttf&#39;s Space">
<meta property="og:description" content="https:&#x2F;&#x2F;github.com&#x2F;dytttf">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Dytttf">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://www.dytttf.com/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Dytttf's Space</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Dytttf's Space</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">There is no one</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Dytttf</p>
  <div class="site-description" itemprop="description">https://github.com/dytttf</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">25</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://kalacloud.com/" title="https:&#x2F;&#x2F;kalacloud.com" rel="noopener" target="_blank">卡拉云低代码工具</a>
        </li>
    </ul>
  </div>

          </div>
        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="Back to top">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    

  <a href="https://github.com/dytttf" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.dytttf.com/2023/01/02/%E9%80%9A%E8%BF%87socket%E5%AE%9E%E7%8E%B0%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dytttf">
      <meta itemprop="description" content="https://github.com/dytttf">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dytttf's Space">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/01/02/%E9%80%9A%E8%BF%87socket%E5%AE%9E%E7%8E%B0%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F/" class="post-title-link" itemprop="url">通过socket实现内网穿透</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-01-02 23:13:17" itemprop="dateCreated datePublished" datetime="2023-01-02T23:13:17+08:00">2023-01-02</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="内网穿透"><a href="#内网穿透" class="headerlink" title="内网穿透"></a><strong>内网穿透</strong></h1><p>一般企业都有内部网络，访问内部服务时，必须使用VPN、远程桌面等手段先连接到内网，才能访问内部服务。</p>
<p>而内网穿透，即通过某些技术手段，将内部服务暴露到公网上，无需VPN即可访问内部服务。</p>
<h1 id="基本原理"><a href="#基本原理" class="headerlink" title="基本原理"></a><strong>基本原理</strong></h1><p>前提条件：</p>
<ol>
<li>拥有一台可通过公网访问的服务器。记为 公网服务A</li>
<li>内部网络中有一台既可以访问公网，又可以访问目标内网服务的服务器。记为 内网服务B</li>
</ol>
<p>如果是 Linux 环境，直接使用 SSH 即可。参见:<a href="https://www.dytttf.com/2022/02/07/SSH%E7%94%A8%E4%BA%8E%E9%9A%A7%E9%81%93%E4%BB%A3%E7%90%86%E7%9A%84%E4%B8%80%E4%BA%9B%E5%9C%BA%E6%99%AF/">SSH用于隧道代理的一些场景</a></p>
<p>如果是 Windows 环境，请继续。</p>
<p>内网穿透的基本做法如下：</p>
<ol>
<li>内网服务B 主动访问 公网服务A，并建立连接。</li>
<li>公网服务A 接收客户端（用户）的访问，并将访问流量转发至 内网服务B，然后接收响应数据并返回给 客户端（用户）</li>
<li>内网服务B 将收到的从 公网服务A 来的流量转发至 内网目标服务，然后接收响应数据并返回给 公网服务A</li>
</ol>
<p>如下图：</p>
<p><img src="https://images.dytttf.com/images/blog/202301022329679.jpg">  </p>
<h1 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a><strong>代码实现</strong></h1><p>代码地址：<a target="_blank" rel="noopener" href="https://github.com/dytttf/inpe">https://github.com/dytttf/inpe</a></p>
<p>关键点:</p>
<ul>
<li><p>使用select模块对socket进行轮询</p>
</li>
<li><p>多线程</p>
<blockquote>
<p>如果不使用多线程处理流量的话，网速极差，且很容易超时</p>
</blockquote>
</li>
<li><p>心跳</p>
<blockquote>
<p>内网穿透一般会经过防火墙，而防火墙很容易会将空闲连接断开且无任何通知。然后大量连接处于断开状态但服务端确无任何感知，等到使用的时候才会发现断开，导致前期大量请求无效，直到将无效链接消耗完后才能正常访问。</p>
</blockquote>
</li>
</ul>
<h1 id="扩展场景"><a href="#扩展场景" class="headerlink" title="扩展场景"></a><strong>扩展场景</strong></h1><p>如果你将内网服务B接收的流量转发到一个内网socks代理服务，那么你可以通过这个代理访问任何内网服务</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.dytttf.com/2022/06/02/%E6%89%A9%E5%B1%95-openpyxl-%E5%AF%B9-Excel-%E4%B8%AD%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%95%E5%85%83%E6%A0%BC%E6%A0%BC%E5%BC%8F%E7%9A%84%E5%A4%84%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dytttf">
      <meta itemprop="description" content="https://github.com/dytttf">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dytttf's Space">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/06/02/%E6%89%A9%E5%B1%95-openpyxl-%E5%AF%B9-Excel-%E4%B8%AD%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%95%E5%85%83%E6%A0%BC%E6%A0%BC%E5%BC%8F%E7%9A%84%E5%A4%84%E7%90%86/" class="post-title-link" itemprop="url">扩展 openpyxl 对 Excel 中自定义单元格格式的处理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-06-02 23:55:12" itemprop="dateCreated datePublished" datetime="2022-06-02T23:55:12+08:00">2022-06-02</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>在用 openpyxl 读取 Excel 中的数据时，发现某些单元格读取到的是数字 44712，但打开 Excel 文件却显示的是时间：2022年6月2日</p>
<p>查看单元格格式会发现这个单元格属于自定义格式中的: yyyy”年”m”月”d”日”。这个可以理解，但为啥 openpyxl 读到的不是时间呢？</p>
<h2 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h2><p>通过查看 openpyxl 的源码，发现其在 openpyxl.styles.numbers.py 中定义了一组格式,如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">BUILTIN_FORMATS = &#123;</span><br><span class="line">    <span class="number">0</span>: <span class="string">&#x27;General&#x27;</span>,</span><br><span class="line">    <span class="number">1</span>: <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">    <span class="number">2</span>: <span class="string">&#x27;0.00&#x27;</span>,</span><br><span class="line">    <span class="number">3</span>: <span class="string">&#x27;#,##0&#x27;</span>,</span><br><span class="line">    <span class="number">4</span>: <span class="string">&#x27;#,##0.00&#x27;</span>,</span><br><span class="line">    <span class="number">5</span>: <span class="string">&#x27;&quot;$&quot;#,##0_);(&quot;$&quot;#,##0)&#x27;</span>,</span><br><span class="line">    <span class="number">6</span>: <span class="string">&#x27;&quot;$&quot;#,##0_);[Red](&quot;$&quot;#,##0)&#x27;</span>,</span><br><span class="line">    <span class="number">7</span>: <span class="string">&#x27;&quot;$&quot;#,##0.00_);(&quot;$&quot;#,##0.00)&#x27;</span>,</span><br><span class="line">    <span class="number">8</span>: <span class="string">&#x27;&quot;$&quot;#,##0.00_);[Red](&quot;$&quot;#,##0.00)&#x27;</span>,</span><br><span class="line">    <span class="number">9</span>: <span class="string">&#x27;0%&#x27;</span>,</span><br><span class="line">    <span class="number">10</span>: <span class="string">&#x27;0.00%&#x27;</span>,</span><br><span class="line">    <span class="number">11</span>: <span class="string">&#x27;0.00E+00&#x27;</span>,</span><br><span class="line">    <span class="number">12</span>: <span class="string">&#x27;# ?/?&#x27;</span>,</span><br><span class="line">    <span class="number">13</span>: <span class="string">&#x27;# ??/??&#x27;</span>,</span><br><span class="line">    <span class="number">14</span>: <span class="string">&#x27;mm-dd-yy&#x27;</span>,</span><br><span class="line">    <span class="number">15</span>: <span class="string">&#x27;d-mmm-yy&#x27;</span>,</span><br><span class="line">    <span class="number">16</span>: <span class="string">&#x27;d-mmm&#x27;</span>,</span><br><span class="line">    <span class="number">17</span>: <span class="string">&#x27;mmm-yy&#x27;</span>,</span><br><span class="line">    <span class="number">18</span>: <span class="string">&#x27;h:mm AM/PM&#x27;</span>,</span><br><span class="line">    <span class="number">19</span>: <span class="string">&#x27;h:mm:ss AM/PM&#x27;</span>,</span><br><span class="line">    <span class="number">20</span>: <span class="string">&#x27;h:mm&#x27;</span>,</span><br><span class="line">    <span class="number">21</span>: <span class="string">&#x27;h:mm:ss&#x27;</span>,</span><br><span class="line">    <span class="number">22</span>: <span class="string">&#x27;m/d/yy h:mm&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="number">37</span>: <span class="string">&#x27;#,##0_);(#,##0)&#x27;</span>,</span><br><span class="line">    <span class="number">38</span>: <span class="string">&#x27;#,##0_);[Red](#,##0)&#x27;</span>,</span><br><span class="line">    <span class="number">39</span>: <span class="string">&#x27;#,##0.00_);(#,##0.00)&#x27;</span>,</span><br><span class="line">    <span class="number">40</span>: <span class="string">&#x27;#,##0.00_);[Red](#,##0.00)&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="number">41</span>: <span class="string">r&#x27;_(* #,##0_);_(* \(#,##0\);_(* &quot;-&quot;_);_(@_)&#x27;</span>,</span><br><span class="line">    <span class="number">42</span>: <span class="string">r&#x27;_(&quot;$&quot;* #,##0_);_(&quot;$&quot;* \(#,##0\);_(&quot;$&quot;* &quot;-&quot;_);_(@_)&#x27;</span>,</span><br><span class="line">    <span class="number">43</span>: <span class="string">r&#x27;_(* #,##0.00_);_(* \(#,##0.00\);_(* &quot;-&quot;??_);_(@_)&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="number">44</span>: <span class="string">r&#x27;_(&quot;$&quot;* #,##0.00_)_(&quot;$&quot;* \(#,##0.00\)_(&quot;$&quot;* &quot;-&quot;??_)_(@_)&#x27;</span>,</span><br><span class="line">    <span class="number">45</span>: <span class="string">&#x27;mm:ss&#x27;</span>,</span><br><span class="line">    <span class="number">46</span>: <span class="string">&#x27;[h]:mm:ss&#x27;</span>,</span><br><span class="line">    <span class="number">47</span>: <span class="string">&#x27;mmss.0&#x27;</span>,</span><br><span class="line">    <span class="number">48</span>: <span class="string">&#x27;##0.0E+0&#x27;</span>,</span><br><span class="line">    <span class="number">49</span>: <span class="string">&#x27;@&#x27;</span>, &#125;</span><br></pre></td></tr></table></figure>

<p>其中并没有我们想要的 yyyy”年”m”月”d”日”。</p>
<p>然后通过查阅 Excel 的官方文档中关于 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/api/documentformat.openxml.spreadsheet.numberingformat?view=openxml-2.8.1">NumberingFormat Class</a> 的解释发现 openpyxl 中定义的这些格式属于通用格式，是不区分语种的。</p>
<p>而我们想要找的这种格式，属于汉语中的特殊格式。对于这种特殊格式， Excel 中仅保存一个格式 ID ，但不保存具体格式的定义，格式的定义会随着所在国家发生变化。</p>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>解决方案很简单，从文档中找到中文对应的格式 ID 和格式字符串的对应关系，然后采用 hook 的方式将其注入 openpyxl 模块中即可。</p>
<p>代码如下：（注意这些代码需要在导入 openpyxl 模块之前执行）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 扩展openpyxl的数字格式</span></span><br><span class="line"><span class="comment"># 此处扩展的是中文格式</span></span><br><span class="line">extra_formats = &#123;</span><br><span class="line">    <span class="number">27</span>: <span class="string">&#x27;yyyy&quot;年&quot;m&quot;月&quot;&#x27;</span>,</span><br><span class="line">    <span class="number">28</span>: <span class="string">&#x27;m&quot;月&quot;d&quot;日&quot;&#x27;</span>,</span><br><span class="line">    <span class="number">29</span>: <span class="string">&#x27;m&quot;月&quot;d&quot;日&quot;&#x27;</span>,</span><br><span class="line">    <span class="number">30</span>: <span class="string">&quot;m-d-yy&quot;</span>,</span><br><span class="line">    <span class="number">31</span>: <span class="string">&#x27;yyyy&quot;年&quot;m&quot;月&quot;d&quot;日&quot;&#x27;</span>,</span><br><span class="line">    <span class="number">32</span>: <span class="string">&#x27;h&quot;时&quot;mm&quot;分&quot;&#x27;</span>,</span><br><span class="line">    <span class="number">33</span>: <span class="string">&#x27;h&quot;时&quot;mm&quot;分&quot;ss&quot;秒&quot;&#x27;</span>,</span><br><span class="line">    <span class="number">34</span>: <span class="string">&#x27;上午/下午h&quot;时&quot;mm&quot;分&quot;&#x27;</span>,</span><br><span class="line">    <span class="number">35</span>: <span class="string">&#x27;上午/下午h&quot;时&quot;mm&quot;分&quot;ss&quot;秒&quot;&#x27;</span>,</span><br><span class="line">    <span class="number">36</span>: <span class="string">&#x27;yyyy&quot;年&quot;m&quot;月&quot;&#x27;</span>,</span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="number">50</span>: <span class="string">&#x27;yyyy&quot;年&quot;m&quot;月&quot;&#x27;</span>,</span><br><span class="line">    <span class="number">51</span>: <span class="string">&#x27;m&quot;月&quot;d&quot;日&quot;&#x27;</span>,</span><br><span class="line">    <span class="number">52</span>: <span class="string">&#x27;yyyy&quot;年&quot;m&quot;月&quot;&#x27;</span>,</span><br><span class="line">    <span class="number">53</span>: <span class="string">&#x27;m&quot;月&quot;d&quot;日&quot;&#x27;</span>,</span><br><span class="line">    <span class="number">54</span>: <span class="string">&#x27;m&quot;月&quot;d&quot;日&quot;&#x27;</span>,</span><br><span class="line">    <span class="number">55</span>: <span class="string">&#x27;上午/下午h&quot;时&quot;mm&quot;分&quot;&#x27;</span>,</span><br><span class="line">    <span class="number">56</span>: <span class="string">&#x27;上午/下午h&quot;时&quot;mm&quot;分&quot;ss&quot;秒&quot;&#x27;</span>,</span><br><span class="line">    <span class="number">57</span>: <span class="string">&#x27;yyyy&quot;年&quot;m&quot;月&quot;&#x27;</span>,</span><br><span class="line">    <span class="number">58</span>: <span class="string">&#x27;m&quot;月&quot;d&quot;日&quot;&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">from</span> openpyxl.styles.numbers <span class="keyword">import</span> BUILTIN_FORMATS</span><br><span class="line"></span><br><span class="line">BUILTIN_FORMATS.update(extra_formats)</span><br></pre></td></tr></table></figure>

<p>参考文档：</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/api/documentformat.openxml.spreadsheet.numberingformat?view=openxml-2.8.1">https://docs.microsoft.com/en-us/dotnet/api/documentformat.openxml.spreadsheet.numberingformat?view=openxml-2.8.1</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.dytttf.com/2022/05/11/MAC%E8%BF%9C%E7%A8%8Bwindows%E9%81%87%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E9%97%AE%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dytttf">
      <meta itemprop="description" content="https://github.com/dytttf">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dytttf's Space">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/05/11/MAC%E8%BF%9C%E7%A8%8Bwindows%E9%81%87%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E9%97%AE%E9%A2%98/" class="post-title-link" itemprop="url">MAC远程windows遇到的一些问题</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-05-11 21:35:57" itemprop="dateCreated datePublished" datetime="2022-05-11T21:35:57+08:00">2022-05-11</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>&amp;ensp;&amp;ensp;最近居家办公，公司的电脑是 windows 环境，由于安全策略，需要远程连接公司内电脑进行办公。<br>&amp;ensp;&amp;ensp;首先连接 VPN，然后登录网页堡垒机，通过堡垒机调用本地 mstsc 进行远程桌面</p>
<h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>&amp;ensp;&amp;ensp;家里电脑是 mac ，由于堡垒机只能调用 mstsc ，所以需要 windows 环境来使用，一开始我用的是 Parallels Desktop ,连接我装的双系统中的 windows 环境。这样我可以同时两套环境使用，比较方便。但有两个问题使我不得不放弃了这种方式：</p>
<ol>
<li>远程到公司电脑后，分辨率贼高。然后看到的字都非常小，由于公司内的办公电脑没有管理员权限，也无法修复这个问题。</li>
<li>组合键使用起来有问题，比如 Ctrl + C ,当第一次按下 Ctrl + C 时，远端接收到的只有 C，不松 Ctrl，再次按 C，才是复制功能。然后比如输入一些特殊符号，需要用到 Shift 组合键，比如 Shift + *，远端显示的是 8。临时解决办法是 Ctrl + Shift + * ，才能正确输入 *。</li>
</ol>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>&amp;ensp;&amp;ensp;这些问题，坑了我好几天。当我开始使用 Virtual Box + windows 虚拟机后。问题 2，直接就没有了，组合键恢复。但问题 1 分辨率还是有问题，然后通过设置虚拟机的缩放率：控制 -&gt; 显示 -&gt; 缩放率 就可以了。根据自己的需求进行设置就可以，推荐150%。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.dytttf.com/2022/02/07/SSH%E7%94%A8%E4%BA%8E%E9%9A%A7%E9%81%93%E4%BB%A3%E7%90%86%E7%9A%84%E4%B8%80%E4%BA%9B%E5%9C%BA%E6%99%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dytttf">
      <meta itemprop="description" content="https://github.com/dytttf">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dytttf's Space">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/02/07/SSH%E7%94%A8%E4%BA%8E%E9%9A%A7%E9%81%93%E4%BB%A3%E7%90%86%E7%9A%84%E4%B8%80%E4%BA%9B%E5%9C%BA%E6%99%AF/" class="post-title-link" itemprop="url">SSH用于隧道代理的一些场景</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-02-07 17:15:26" itemprop="dateCreated datePublished" datetime="2022-02-07T17:15:26+08:00">2022-02-07</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h1><p><strong>修改中转服务器上的 sshd 服务配置项：GatewayPorts yes 这样当使用 -R 参数进行转发时中转服务器会监听 0.0.0.0 而不是 127.0.0.1</strong></p>
<h1 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h1><p>1、将 A 机器的某个端口映射到 B 机器的某个端口</p>
<p>例如: </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -f -N -R 0.0.0.0:80:0.0.0.0:80 root@remote_ip</span><br></pre></td></tr></table></figure>

<p>此命令会将本地机器的 80 端口映射到远程服务器（1.1.1.1）的 80 端口。当别人访问远程服务器的 80 端口时，流量就会被转发到本地的 80端口。</p>
<p>参数解析：</p>
<ul>
<li><p>-R remote_ip:remote_port:local_ip:local_port 当不指定本地IP和端口时，remote_ip:remote_port 将会表现为 socks4&#x2F;5代理</p>
</li>
<li><p>-f 使ssh命令后台运行</p>
</li>
<li><p>-N Do not execute a remote command.  This is useful for just forwarding ports.</p>
</li>
</ul>
<p>2、启动 socks 代理服务</p>
<p>在本地启动 socks代理：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -N -D 0.0.0.0:1080 root@127.0.0.1</span><br></pre></td></tr></table></figure>



<p>3、SSH 关键参数：</p>
<ul>
<li><p>-R：将远程的流量接过来</p>
</li>
<li><p>-L：将自己的流量转发出去</p>
</li>
</ul>
<h1 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h1><h3 id="案例1：云手机走本地-fiddler-代理"><a href="#案例1：云手机走本地-fiddler-代理" class="headerlink" title="案例1：云手机走本地 fiddler 代理"></a>案例1：云手机走本地 fiddler 代理</h3><p>准备：</p>
<p>1、一台有公网 IP 的服务器</p>
<p>2、自己的电脑能够通过 ssh 访问 1 的服务器</p>
<p>步骤：</p>
<p>1、本地启动 fiddler</p>
<p>2、本地使用 ssh 将本地 8889 端口（fiddler 端口）映射到服务器的 8889 端口</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -N -R 0.0.0.0:8889:127.0.0.1:8889 root@remote_ip</span><br></pre></td></tr></table></figure>

<p>3、云手机增加代理：ip 为服务器的公网 ip，端口为 8889</p>
<p>可能的问题：</p>
<p>1、使用不当会造成本地 tcp 连接过多，卡死代理</p>
<p>一句话总结：将有公网IP的服务器的端口流量转发到本地电脑</p>
<h3 id="案例2：远程连接云手机的-frida-服务"><a href="#案例2：远程连接云手机的-frida-服务" class="headerlink" title="案例2：远程连接云手机的 frida 服务"></a>案例2：远程连接云手机的 frida 服务</h3><p>准备：</p>
<p>1、云手机开启 frida-server, 端口为 27042</p>
<p>2、云手机可运行 ssh </p>
<p>3、一台有公网 ip 的服务器 A</p>
<p>步骤：</p>
<p>1、云手机 ssh 公钥放到服务器 A 上</p>
<p>2、将云手机的端口映射到服务器 A 上</p>
<p>例如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -p 22 -N -R 0.0.0.0:27042:127.0.0.1:27042 root@A</span><br></pre></td></tr></table></figure>

<p>3、本地通过服务器 A 的 ip:27042 访问云手机的 frida-server</p>
<p>一句话总结：将访问具有公网IP的服务器的流量转发到云手机，转发行为发起人是云手机</p>
<h3 id="案例3：远程连接云手机的-ssh-服务"><a href="#案例3：远程连接云手机的-ssh-服务" class="headerlink" title="案例3：远程连接云手机的 ssh 服务"></a>案例3：远程连接云手机的 ssh 服务</h3><p>准备：</p>
<p>1、云手机可运行 ssh </p>
<p>2、一台有公网 ip 的服务器 A</p>
<p>步骤：</p>
<p>1、云手机 ssh 公钥放到服务器 A 上</p>
<p>2、云手机将自己的 22 端口映射到服务器 A 的 8022 端口 </p>
<p>例如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -p 22 -NR 0.0.0.0:8022:127.0.0.1:22 root@A_ip</span><br></pre></td></tr></table></figure>

<p>3、本地通过服务器ip_port访问云手机</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -p 8022 root@A_ip</span><br></pre></td></tr></table></figure>

<p>一句话总结：将访问具有公网IP的服务器的流量转发到云手机，转发行为发起人是云手机</p>
<h1 id="隧道稳定性"><a href="#隧道稳定性" class="headerlink" title="隧道稳定性"></a>隧道稳定性</h1><p>SSH 隧道在网络波动的情况下会断掉，所以需要有守护进程来保证断掉重连，推荐使用 autossh</p>
<p>autossh 只能设置免密登录，否则 autossh 不能运行，因为自动重连的时候如果没有免密，是没办法输入密码的</p>
<p>用法参见 autossh 文档</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">autossh -f -M 0 [SSH OPTIONS]</span><br></pre></td></tr></table></figure>

<p>某些时候会出现 ssh 链接仍在，但端口转发失败的情况，此时 autossh 不会自动重启 ssh，可配合定时任务，定时 kill ssh 进程，然后 autossh 会进行重启。</p>
<h1 id="socks-代理应用"><a href="#socks-代理应用" class="headerlink" title="socks 代理应用"></a>socks 代理应用</h1><p>案例1: </p>
<p>当公司仅允许通过jumpserver访问服务器，并且禁止了 vpn 的 22 端口时:</p>
<ol>
<li><p>在服务器上启动代理 ssh -p22 -fqND 0.0.0.0:6565 <a href="mailto:&#x72;&#x6f;&#x6f;&#x74;&#x40;&#x31;&#50;&#55;&#x2e;&#x30;&#46;&#48;&#x2e;&#49;">&#x72;&#x6f;&#x6f;&#x74;&#x40;&#x31;&#50;&#55;&#x2e;&#x30;&#46;&#48;&#x2e;&#49;</a></p>
</li>
<li><p>本地配合 ProxyCommand</p>
</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -o ProxyCommand=&#x27;nc -X 5 -x 10.40.34.248:6565 %h %p&#x27; root@remote_ip</span><br></pre></td></tr></table></figure>



<p>案例2:</p>
<p>云厂商的服务器公网 IP 都是非住宅类的，而某些应用或服务限制了此类IP，此时可以搭建代理配合 proxifier 使服务器流量走本地。</p>
<p>如下命令，可以在本地启动一个  socks5 代理 监听8880，并将远程机器的 </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -N -R 0.0.0.0:8889 root@remote_ip</span><br></pre></td></tr></table></figure>
<p>将本地端口映射到远程服务器端口， 使远程服务器可通过本地网络上网</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.dytttf.com/2022/01/24/%E6%90%AD%E5%BB%BA-MinIO-Gateway-%E7%9A%84%E4%B8%80%E7%82%B9%E7%82%B9%E9%97%AE%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dytttf">
      <meta itemprop="description" content="https://github.com/dytttf">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dytttf's Space">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/01/24/%E6%90%AD%E5%BB%BA-MinIO-Gateway-%E7%9A%84%E4%B8%80%E7%82%B9%E7%82%B9%E9%97%AE%E9%A2%98/" class="post-title-link" itemprop="url">搭建 MinIO Gateway 的一点点问题</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-01-24 13:03:39" itemprop="dateCreated datePublished" datetime="2022-01-24T13:03:39+08:00">2022-01-24</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>MinIO Gateway 是一款可以代理 S3、Azure、Nas、HDFS 等服务的软件。可以让用户以兼容 S3 的方式来访问所代理的服务。</p>
<p>具体介绍见：<a target="_blank" rel="noopener" href="https://docs.min.io/docs/minio-gateway-for-s3.html">https://docs.min.io/docs/minio-gateway-for-s3.html</a></p>
<h1 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h1><p>一、一套代码支持不同对象存储产品。</p>
<p>当前市面常见的对象存储产品有：</p>
<ul>
<li>阿里云 OSS</li>
<li>腾讯云 COS</li>
<li>华为云 OBS</li>
<li>Amazon S3</li>
<li>开源 MinIO</li>
</ul>
<p>如果你的服务需要使用对象存储，但不同的场景下使用的对象存储服务并不一致，为了避免增加代码开发中适配多种产品的复杂性，</p>
<p>可以使用 MinIO Gateway 做一层代理，代码中仅需支持 MinIO 的访问方式即可。</p>
<p>二、避免大量开通云服务子帐号。</p>
<p>在公司内部，当我们使用云服务商的对象存储产品时，是必须开通云产品的子帐号才能访问的。而子帐号的开通和管理其实并不是</p>
<p>很方便，并且还没办法接入比如 LDAP 等帐号管理系统。此时也可以将对象存储服务用 MinIO Gateway 做一层代理，然后通过 Gateway </p>
<p>来管理对象存储服务的帐号，支持各种帐号管理方式。比如 Keycloak、 LDAP、内部用户等。</p>
<p>具体参见：<a target="_blank" rel="noopener" href="https://docs.min.io/docs/minio-sts-quickstart-guide">https://docs.min.io/docs/minio-sts-quickstart-guide</a></p>
<h1 id="MinIO-Gateway-搭建"><a href="#MinIO-Gateway-搭建" class="headerlink" title="MinIO Gateway 搭建"></a>MinIO Gateway 搭建</h1><p>基本搭建步骤参考官方文档：<a target="_blank" rel="noopener" href="https://docs.min.io/docs/minio-gateway-for-s3.html">https://docs.min.io/docs/minio-gateway-for-s3.html</a></p>
<p>可以使用 docker 或者二进制文件等方式启动 Gateway 服务。</p>
<h1 id="下面说点不一样的"><a href="#下面说点不一样的" class="headerlink" title="下面说点不一样的"></a>下面说点不一样的</h1><h2 id="MinIO-编译"><a href="#MinIO-编译" class="headerlink" title="MinIO 编译"></a>MinIO 编译</h2><p>编译很简单，MinIO 使用 Go 语言开发，所以需要安装 Go，参见：<a target="_blank" rel="noopener" href="https://go.dev/doc/install">https://go.dev/doc/install</a></p>
<p>然后源码中已经有写好的 Makefile，直接执行 make 即可。</p>
<h2 id="适配腾讯云-COS"><a href="#适配腾讯云-COS" class="headerlink" title="适配腾讯云 COS"></a>适配腾讯云 COS</h2><p>MinIO Gateway 在启动时会随机生成一个 Bucket 名称，然后利用检查 Bucket 是否存在的 API 确认 S3 服务是否可用，期待的返回状态码是 404，</p>
<p>但腾讯云 COS 强制每个 Bucket 的名字后缀为一串数字 ID，如果不符合格式，则响应 400，导致 MinIO Gateway 探测失败。</p>
<p>日志如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">---------START-HTTP---------</span></span><br><span class="line"><span class="string">GET /probe-bucket-sign-99lrqve1qm4x/?location= HTTP/1.1</span></span><br><span class="line"><span class="string">Host: cos.ap-beijing.myqcloud.com</span></span><br><span class="line"><span class="string">User-Agent: MinIO (darwin; amd64) minio-go/v7.0.20</span></span><br><span class="line"><span class="string">Authorization: AWS4-HMAC-SHA256 Credential=AKID2uWrwlJabKnzwd3CCwPbWBZhZBWZLr64/20220118/us-east-1/s3/aws4_request, SignedHeaders=host;x-amz-content-sha256;x-amz-date, Signature=**REDACTED**</span></span><br><span class="line"><span class="string">X-Amz-Content-Sha256: UNSIGNED-PAYLOAD</span></span><br><span class="line"><span class="string">X-Amz-Date: 20220118T155622Z</span></span><br><span class="line"><span class="string">Accept-Encoding: gzip</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">HTTP/1.1 400 Bad Request</span></span><br><span class="line"><span class="string">Content-Length: 437</span></span><br><span class="line"><span class="string">Connection: keep-alive</span></span><br><span class="line"><span class="string">Content-Type: application/xml</span></span><br><span class="line"><span class="string">Date: Tue, 18 Jan 2022 15:56:25 GMT</span></span><br><span class="line"><span class="string">Server: tencent-cos</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;?xml version=&#x27;1.0&#x27; encoding=&#x27;utf-8&#x27; ?&gt;</span></span><br><span class="line"><span class="string">&lt;Error&gt;</span></span><br><span class="line"><span class="string">	&lt;Code&gt;InvalidURI&lt;/Code&gt;</span></span><br><span class="line"><span class="string">	&lt;Message&gt;Could not parse the specified URI.&lt;/Message&gt;</span></span><br><span class="line"><span class="string">	&lt;Resource&gt;cos.ap-beijing.myqcloud.com/probe-bucket-sign-99lrqve1qm4x&lt;/Resource&gt;</span></span><br><span class="line"><span class="string">&lt;/Error&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">---------END-HTTP---------</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>



<p>在 MinIO 官方以及腾讯云官方都不做修改的情况下，只能通过修改源码重新编译来解决问题。</p>
<p>代码修改位置如下：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/minio/minio/cmd/gateway/s3/gateway-s3.go">https://github.com/minio/minio/cmd/gateway/s3/gateway-s3.go</a></p>
</blockquote>
<p>将其中的 randString 函数返回值修改为数字后缀，比如下图：</p>
<img src="https://images.dytttf.com/images/20220124131019.png" alt="img" style="zoom:67%;" />

<p>然后编译即可。</p>
<h2 id="使用独立帐号体系"><a href="#使用独立帐号体系" class="headerlink" title="使用独立帐号体系"></a>使用独立帐号体系</h2><p>默认情况下，MinIO 自带一套帐号管理体系，不需要任何配置，但缺点是一旦服务重启则帐号信息丢失。</p>
<p>为了持久化存储帐号数据，需要配合 Etcd 服务。</p>
<p>Etcd部署参见：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/etcd-io/etcd/releases">https://github.com/etcd-io/etcd/releases</a></p>
</blockquote>
<p>MinIO Gateway 启动方式如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line">export MINIO_ROOT_USER=&quot;Access Key&quot;</span><br><span class="line">export MINIO_ROOT_PASSWORD=&quot;Access Secret&quot;</span><br><span class="line">export _MINIO_SERVER_DEBUG=off # 是否开启DEBUG 仅为了查看日志 on|off</span><br><span class="line">export MINIO_ETCD_ENDPOINTS=http://localhost:2379 # 使用 ETCD 持久化存储内部用户</span><br><span class="line">export MINIO_ETCD_PATH_PREFIX=minio/ # ETCD 中存储的数据的前缀</span><br><span class="line">./minio gateway s3 https://cos.ap-beijing.myqcloud.com --console-address 0.0.0.0:9100</span><br></pre></td></tr></table></figure>



<p>不过这种方式有个缺点，新创建的 MinIO Gateway 账密是明文存储在 Etcd 中的。。。</p>
<p>解决办法如下：</p>
<ol>
<li><p>控制 Etcd 的访问权限，避免被其他人访问。</p>
</li>
<li><p>使用 MinIO 自己的加密方式，参考：<a target="_blank" rel="noopener" href="https://docs.min.io/docs/minio-kms-quickstart-guide.html%E3%80%82%E4%BD%86%E5%8A%A0%E5%AF%86%E8%BF%99%E4%B8%AA%E5%8A%9F%E8%83%BD%EF%BC%8C%E5%8A%A0%E5%AF%86%E7%9A%84%E5%9C%B0%E6%96%B9%E6%9C%89%E7%82%B9%E5%A4%9A%EF%BC%8C%E8%80%8C%E4%B8%94%E6%9C%89%E7%82%B9%E5%B0%8FBUG%EF%BC%8C%E6%AF%94%E5%A6%82%E5%B1%95%E7%A4%BA%E5%87%BA%E6%9D%A5%E7%9A%84S3%E6%96%87%E4%BB%B6%E5%88%97%E8%A1%A8%E4%B8%8D%E5%85%A8%E3%80%82%E3%80%82%E3%80%82%E6%89%80%E4%BB%A5%E6%88%91%E6%94%BE%E5%BC%83%E4%BA%86%E3%80%82">https://docs.min.io/docs/minio-kms-quickstart-guide.html。但加密这个功能，加密的地方有点多，而且有点小BUG，比如展示出来的S3文件列表不全。。。所以我放弃了。</a></p>
</li>
</ol>
<h2 id="集成-LDAP"><a href="#集成-LDAP" class="headerlink" title="集成 LDAP"></a>集成 LDAP</h2><p>官方文档：<a target="_blank" rel="noopener" href="https://github.com/minio/minio/blob/master/docs/sts/ldap.md">https://github.com/minio/minio/blob/master/docs/sts/ldap.md</a></p>
<p>启动方式如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line">export MINIO_ROOT_USER=&quot;Access Key&quot;</span><br><span class="line">export MINIO_ROOT_PASSWORD=&quot;Access Secret&quot;</span><br><span class="line">export _MINIO_SERVER_DEBUG=off # 是否开启DEBUG 仅为了查看日志  on|off</span><br><span class="line">export MINIO_IDENTITY_LDAP_SERVER_ADDR=&quot;LDAP服务器:LDAP服务端口&quot;</span><br><span class="line">export MINIO_IDENTITY_LDAP_LOOKUP_BIND_DN=&quot;&#123;LDAP 帐号&#125;&quot; # 例如 cn=readonly,dc=test,dc=com  仅用只读帐号即可</span><br><span class="line">export MINIO_IDENTITY_LDAP_LOOKUP_BIND_PASSWORD=&quot;&#123;LDAP 密码&#125;&quot;</span><br><span class="line">export MINIO_IDENTITY_LDAP_USER_DN_SEARCH_BASE_DN=&#x27;ou=People,dc=test,dc=com&#x27; # 搜索域</span><br><span class="line">export MINIO_IDENTITY_LDAP_USER_DN_SEARCH_FILTER=&#x27;(uid=%s)&#x27; # 用来过滤登录的帐号 %s会被填充用户名</span><br><span class="line">export MINIO_IDENTITY_LDAP_TLS_SKIP_VERIFY=on</span><br><span class="line">export MINIO_IDENTITY_LDAP_SERVER_INSECURE=on</span><br><span class="line">export MINIO_IDENTITY_LDAP_SERVER_STARTTLS=off</span><br><span class="line">./minio gateway s3 https://cos.ap-beijing.myqcloud.com --console-address 0.0.0.0:9100</span><br></pre></td></tr></table></figure>



<p>集成 LDAP 的好处就是不用单独开通帐号即可使用，但比较麻烦的是，只能通过命令行 mc 来对用户进行授权。而且当需要给公司外部人员开通帐号时，也必须得开通 LDAP 帐号，可能面临一定的风险。</p>
<h2 id="集成-Audit-Log-功能（审计日志）"><a href="#集成-Audit-Log-功能（审计日志）" class="headerlink" title="集成 Audit Log 功能（审计日志）"></a>集成 Audit Log 功能（审计日志）</h2><p>默认情况下，当仅仅使用 MinIO 的 Gateway 功能时，Admin API 以及很多特性比如 Audit log 都是没有开放的。</p>
<p>这个时候就又到了改代码重新编译的时候。</p>
<p>首先是启用 Admin API，修改代码位置如下：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/minio/minio/cmd/gateway-main.go">https://github.com/minio/minio/cmd/gateway-main.go</a></p>
</blockquote>
<p>将下图所示地方改为 true:</p>
<img src="https://dytttf-images.oss-cn-beijing.aliyuncs.com/images/20220124131639.png" style="zoom:67%;" />

<p>然后重新编译即可。</p>
<p>下面是开启 Audit log。参见：<a target="_blank" rel="noopener" href="https://github.com/minio/operator/tree/master/logsearchapi">https://github.com/minio/operator/tree/master/logsearchapi</a></p>
<p>按照文档步骤，启动 postgres 数据库，然后启动 logsearchapi 服务，这些都没有问题。</p>
<p>postgres启动：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">    --name postgres \</span><br><span class="line">    -p 5432:5432 \</span><br><span class="line">    -e POSTGRES_PASSWORD=&quot;xxx&quot; \</span><br><span class="line">    -e PGDATA=/var/lib/postgresql/data/pgdata \</span><br><span class="line">    -v /data/postgres:/var/lib/postgresql/data \</span><br><span class="line">    postgres:14.1 -c &quot;log_statement=all&quot;</span><br></pre></td></tr></table></figure>

<p>logsearchapi启动（注意 logsearchapi 命令也是需要下载源码然后编译的）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">export LOGSEARCH_PG_CONN_STR=&quot;postgres://postgres:xxx@localhost/postgres?sslmode=disable&quot;</span><br><span class="line">export LOGSEARCH_AUDIT_AUTH_TOKEN=logsearch_audit</span><br><span class="line">export MINIO_LOG_QUERY_AUTH_TOKEN=logsearch_query</span><br><span class="line">export LOGSEARCH_DISK_CAPACITY_GB=5</span><br><span class="line">./logsearchapi</span><br></pre></td></tr></table></figure>

<p>但当我尝试使用 mc admin 命令设置 aduit_webhook 参数时，却会出现莫名奇妙的错误，一番尝试后放弃，改用其他方式。</p>
<p>将如下代码加入启动脚本即可：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">audit <span class="built_in">log</span> 功能</span></span><br><span class="line">export MINIO_AUDIT_WEBHOOK_ENABLE_1=&quot;on&quot; # audit log 功能</span><br><span class="line">export MINIO_AUDIT_WEBHOOK_ENDPOINT_1=&quot;http://localhost:8080/api/ingest?token=logsearch_audit&quot; # audit log 功能</span><br><span class="line">export MINIO_LOG_QUERY_URL=&quot;http://localhost:8080&quot;</span><br><span class="line">export MINIO_LOG_QUERY_AUTH_TOKEN=&quot;logsearch_query&quot;</span><br><span class="line">export LOGSEARCH_QUERY_AUTH_TOKEN=&quot;logsearch_query&quot;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.dytttf.com/2022/01/05/Python-%E7%9A%84-import-%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6%E4%B8%8E-s3fs-%E7%9A%84%E5%86%B2%E7%AA%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dytttf">
      <meta itemprop="description" content="https://github.com/dytttf">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dytttf's Space">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/01/05/Python-%E7%9A%84-import-%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6%E4%B8%8E-s3fs-%E7%9A%84%E5%86%B2%E7%AA%81/" class="post-title-link" itemprop="url">Python 的 import 缓存机制与 s3fs 的冲突</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-01-05 16:59:27" itemprop="dateCreated datePublished" datetime="2022-01-05T16:59:27+08:00">2022-01-05</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>一个用来运行 Python 代码的 Jupyter 服务，由于某些原因，将 Python 的 pip 包安装目录使用 s3fs 挂载到了 MinIO。</p>
<p>然后就发生了一个很奇怪的现象，当使用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">! pip install module</span><br></pre></td></tr></table></figure>



<p>安装某个包，然后代码中使用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> module</span><br></pre></td></tr></table></figure>



<p>来导入包时，总会报错显示找不到包。但当重启了 jupyter 服务后，import module 就会正常运行。</p>
<h1 id="排查步骤及原因分析"><a href="#排查步骤及原因分析" class="headerlink" title="排查步骤及原因分析"></a>排查步骤及原因分析</h1><p>一. 确认在 !pip install module 执行之后，在 import 执行前，对应库的安装文件确实存在。</p>
<p>通过如下代码确认包安装后的路径：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> module</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(module)</span><br></pre></td></tr></table></figure>



<p>结果是文件确实存在。</p>
<p>二. 研究 Python 的导包机制，分析为何没有找到包。</p>
<p>具体源码参见 importlib 标准库。通过追踪如下代码的调用链</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">importlib.import_module(<span class="string">&quot;module&quot;</span>)</span><br></pre></td></tr></table></figure>



<p>发现有几个可疑点使用了缓存：</p>
<ol>
<li>sys.path_importer_cache</li>
</ol>
<p>此对象数据结构就是一个字典。key 是路径,value 是查找器对象（比如 importlib._bootstrap_external.FileFinder ）</p>
<p>每次对包的查找，都会使用这个缓存来记录查找过的路径。这样下次就可以很快的定位，主要是为了提高找包效率。</p>
<p>当导入一个包时，包所在的目录及其上级目录都会在 sys.path_importer_cache 里有记录。这样当第二次导入同目录下的包时，就不需要再次遍历子目录。</p>
<p>但同样的，如果缓存的 value 出了问题，那么就会影响此路径下包的导入</p>
<ol start="2">
<li>importlib._bootstrap_external.FileFinder</li>
</ol>
<p>此对象在构建时会缓存指定路径下的目录列表。避免多次调用操作系统接口来获取目录，也是为了提高效率。</p>
<p>但目录下的文件在安装包之后是会变化的，所以 FileFinder 本身也有一个机制来发现目录的变化，用的是目录的 mtime 修改时间</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mtime = _path_stat(self.path <span class="keyword">or</span> _os.getcwd()).st_mtime</span><br><span class="line"></span><br><span class="line">// posix.stat(path).st_mtime</span><br><span class="line"></span><br><span class="line">// nt.stat(path).st_mtime</span><br></pre></td></tr></table></figure>



<p>当发现目录的 mtime 发生了变化时，会刷新缓存。</p>
<p>看起来很合理，也确实合理，但就是还是找不到包。</p>
<p>三. 重点锁定 FileFinder 的缓存机制，测试是否触发了缓存刷新。</p>
<p>通过输出 !pip install module 执行前后，对应目录的 mtime, 发现没有变化而且都是 0。</p>
<p>此时问题其实就定位到了 s3fs 挂载的目录无法修改 mtime 的问题。</p>
<p>正常的操作系统目录，当目录内有文件发生改变时，目录的 mtime 也会相应发生改变。而通过 s3fs 挂载的目录则不会。</p>
<p>也没有办法修改。</p>
<p>猜测一下原因：</p>
<p>&amp;ensp;&amp;ensp;S3本来是没有目录的概念的，所谓的目录仅仅是对同样前缀的文件的虚拟，并不是真实存在的一个东西。</p>
<p>但一般文件系统的目录是真实存在于磁盘上。所以如果要实现目录内文件修改的同时同步修改目录属性，则</p>
<p>s3fs 就需要额外的地方来存储这些信息，但这些信息无论是放在主机上，还是放在S3上都不太合适。一旦支</p>
<p>持了，就需要考虑多主机挂载同一目录时的同步问题。</p>
<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><p>&amp;ensp;&amp;ensp;s3fs 这个问题无法解决，所以目录一旦缓存就无法自动刷新。</p>
<p>&amp;ensp;&amp;ensp;所能做的就是在每次 !pip install module 之后手动将 sys.path_importer_cache 置为空字典，强制触发磁盘扫描。</p>
<h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><p><a target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3/library/sys.html#sys.path_importer_cache">https://docs.python.org/zh-cn/3/library/sys.html#sys.path_importer_cache</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zhaojiedi1992/p/zhaojiedi_linux_031_linuxtime.html">https://www.cnblogs.com/zhaojiedi1992/p/zhaojiedi_linux_031_linuxtime.html</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.dytttf.com/2021/12/12/%E5%9C%A8%E9%98%BF%E9%87%8C%E4%BA%91%E4%B8%8A%E9%83%A8%E7%BD%B2%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%9C%80%E7%9C%81%E9%92%B1%E7%9A%84%E6%96%B9%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dytttf">
      <meta itemprop="description" content="https://github.com/dytttf">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dytttf's Space">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/12/12/%E5%9C%A8%E9%98%BF%E9%87%8C%E4%BA%91%E4%B8%8A%E9%83%A8%E7%BD%B2%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%9C%80%E7%9C%81%E9%92%B1%E7%9A%84%E6%96%B9%E5%BC%8F/" class="post-title-link" itemprop="url">在阿里云上部署定时任务最省钱的方式</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-12-12 23:09:10" itemprop="dateCreated datePublished" datetime="2021-12-12T23:09:10+08:00">2021-12-12</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>有一个很简单的爬虫项目，没啥反爬，代码也很简单，数据量也不大，就是每天都需要运行一遍，并且数据持久化存储。</p>
<h1 id="解决方案参考"><a href="#解决方案参考" class="headerlink" title="解决方案参考"></a>解决方案参考</h1><h2 id="方案一（ECS）"><a href="#方案一（ECS）" class="headerlink" title="方案一（ECS）"></a>方案一（ECS）</h2><p>阿里云 ECS：<a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/25398.html">https://help.aliyun.com/document_detail/25398.html</a></p>
<p>方案说明：<br>买台服务器,想干啥干啥。根据自己的需求购买相应的配置。</p>
<p>优点:</p>
<ol>
<li>非常简单易用，不需要多说了</li>
</ol>
<p>缺点:</p>
<ol>
<li>贵。最便宜的服务器也要一个月30+。</li>
</ol>
<h2 id="方案二（函数计算）"><a href="#方案二（函数计算）" class="headerlink" title="方案二（函数计算）"></a>方案二（函数计算）</h2><p>白嫖阿里云函数计算的免费额度：<a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/54301.html">https://help.aliyun.com/document_detail/54301.html</a></p>
<ul>
<li>调用次数：每月前100万次函数调用免费。</li>
<li>函数实例资源使用量：每月前400,000 GB-秒函数实例资源使用量免费。</li>
</ul>
<p>方案说明：<br>代码部署有两种方式：</p>
<ol>
<li>使用阿里云提供的函数计算环境来部署,阿里云提供了 python、node、php、java、go等运行时环境。详见文档：<a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/73338.html%E3%80%82">https://help.aliyun.com/document_detail/73338.html。</a></li>
<li>使用自定义的 docker 镜像提供服务<br>推荐使用第 2 种方式，第一种方式仅适合非常简单的应用。因为运行时环境版本是固定的，而且依赖安装起来有不少问题。<br>代码部署完成后，如果是定时任务，可选用定时器触发执行。其他类型，可选用 http 调用触发执行。</li>
</ol>
<p>优点</p>
<ol>
<li>按量计费，且有免费额度，一般的小应用免费额度就够用了, 一分钱不用花。</li>
</ol>
<p>缺点</p>
<ol>
<li>最大的缺点是：应用每次运行有时长限制，最大值 120 秒。所以如果你的代码每次运行会超过120秒，那就没办法用这个了。</li>
<li>调试不方便</li>
<li>以 python 为例，纯 python的第三方依赖安装没有问题，但一旦涉及到 C 扩展，则依赖无法安装成功。</li>
<li>需要 docker 使用经验</li>
</ol>
<h2 id="方案三（Serverless-容器服务-ASK）"><a href="#方案三（Serverless-容器服务-ASK）" class="headerlink" title="方案三（Serverless 容器服务 ASK）"></a>方案三（<strong>Serverless 容器服务 ASK</strong>）</h2><p>阿里云 Serverless 容器服务 ASK：</p>
<blockquote>
<p>无需创建和管理 Master 节点及 Worker 节点，即可通过控制台或者命令配置容器实例的资源、指定应用容器镜像以及对外服务的方式，直接启动应用程序。</p>
</blockquote>
<p>方案说明：<br>一个 k8s 集群，可以运行任何应用。定时任务可采用 k8s 的 CronJob 方式运行</p>
<p>优点：</p>
<ol>
<li>可扩展性极强，一个 k8s 集群想干啥干啥</li>
<li>按量计费，没有固定节点费用。</li>
<li>简单易用</li>
</ol>
<p>缺点：</p>
<ol>
<li>k8s 集群必须创建一个负载均衡用来提供k8s api服务。最低配的费用 72 元&#x2F;月</li>
<li>如果你的应用需要访问公网，必须配置一个 NAT 网关。最低配的费用 165 元&#x2F;月</li>
<li>需要 k8s 使用经验</li>
</ol>
<h2 id="方案四（Serverless-应用引擎-SAE）"><a href="#方案四（Serverless-应用引擎-SAE）" class="headerlink" title="方案四（Serverless 应用引擎 SAE）"></a>方案四（<strong>Serverless 应用引擎 SAE</strong>）</h2><p>阿里云 Serverless 应用引擎 SAE：<a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/96732.html">https://help.aliyun.com/document_detail/96732.html</a></p>
<ul>
<li>CPU	0.0030864元&#x2F;分钟&#x2F;Core</li>
<li>内存	0.0007716元&#x2F;分钟&#x2F;GiB</li>
</ul>
<p>方案说明：</p>
<ol>
<li>使用自定义 docker 镜像部署一个应用</li>
<li>设置定时启停规则</li>
</ol>
<p>优点：</p>
<ol>
<li>部署简单</li>
<li>按量计费</li>
<li>可以使用钉钉机器人接收应用启动和停止通知。</li>
</ol>
<p>缺点：</p>
<ol>
<li>只能使用定时的方式启动和停止应用，所以需要预估应用运行时间，避免造成不必要的时间浪费或者提前被停止</li>
<li>如果需要访问公网的话，必须提供购买弹性IP。按量付费的话：配置费用 14 元&#x2F;月， 流量费用 0.8 元&#x2F;G</li>
<li>需要提前预估应用耗费的 CPU 和 内存用来选择规格。</li>
</ol>
<h1 id="我的选择"><a href="#我的选择" class="headerlink" title="我的选择"></a>我的选择</h1><p><strong>方案四（Serverless 应用引擎 SAE）</strong></p>
<ol>
<li>爬虫代码运行时间是会超过120秒的</li>
<li>k8s 太贵了，而且我也用不到那么多复杂的功能。</li>
<li>ECS 也太贵了</li>
</ol>
<p>具体实行方案：</p>
<ol>
<li>代码打包成 docker 镜像，docker 镜像托管使用阿里云的容器镜像服务，个人版是免费的，而且同属内网，也会加快镜像拉取速度。</li>
<li>注意启动命令应该是先运行代码，然后阻塞住。如果不阻塞的话，容器在运行完代码后会退出，那么 SAE 服务会自动重启容器，然后你的代码就会再次运行，如此周而复始。。。</li>
<li>配置 SAE 时不需要选择健康探测，也不需要在容器里启动 HTTP 服务。</li>
<li>很重要的一个是数据持久化存储，我选择使用 OSS 服务，将采集后的数据存入 SQLite 数据库, 然后将数据库上传到 OSS 进行持久化存储。</li>
<li>每次修改代码只需要在本地打包成 docker 镜像，然后上传镜像即可。</li>
<li>可以使用钉钉机器人接收数据采集统计信息。</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.dytttf.com/2021/11/30/Web%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9B%B8%E5%85%B3%E7%9A%84%E4%B8%80%E4%BA%9B%E6%A6%82%E5%BF%B5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dytttf">
      <meta itemprop="description" content="https://github.com/dytttf">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dytttf's Space">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/11/30/Web%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9B%B8%E5%85%B3%E7%9A%84%E4%B8%80%E4%BA%9B%E6%A6%82%E5%BF%B5/" class="post-title-link" itemprop="url">Web服务器相关的一些概念</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-11-30 15:33:44" itemprop="dateCreated datePublished" datetime="2021-11-30T15:33:44+08:00">2021-11-30</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>记录一下很常见，但也很容易忽略的一些问题。主要是跟 Web 服务器相关的。</p>
<p>本文涉及到的名词有：</p>
<ul>
<li><p>cgi、fastcgi、wsgi、uwsgi、gunicore、nginx、httpd</p>
</li>
<li><p>Web 服务器</p>
</li>
<li><p>WSGI 服务</p>
</li>
<li><p>Web 框架</p>
</li>
</ul>
<h1 id="Web服务演进"><a href="#Web服务演进" class="headerlink" title="Web服务演进"></a>Web服务演进</h1><p>基本架构：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Client（用户） -&gt; Web服务器 -&gt; 网页源码</span><br></pre></td></tr></table></figure>



<ol>
<li><p>支持最基本的文件访问</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Client -&gt; Web服务器(apache)  -&gt; 静态文件</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>实现动态生成文件功能</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Client -&gt; Web服务器(apache)  -&gt; 静态文件</span></span><br><span class="line"><span class="string">                  |         -&gt; cgi -&gt; 动态生成文件</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>提升 cgi 效率</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Client -&gt; Web服务器(apache) -&gt; 静态文件</span></span><br><span class="line"><span class="string">                  |        -&gt;  fastcgi  -&gt; 动态生成文件</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>提升静态文件效率效率</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Client -&gt; Web服务器(nginx / apache) -&gt; 静态文件</span></span><br><span class="line"><span class="string">                  |                -&gt;  fastcgi -&gt; 动态生成文件</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>某些语言的特定实现方式</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Client -&gt; Web服务器(nginx / apache) -&gt; 静态文件</span></span><br><span class="line"><span class="string">                  |                -&gt; uwsgi  -&gt; flask、django -&gt; 动态生成文件</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Client -&gt; Web服务器(nginx / apache) -&gt; 静态文件</span></span><br><span class="line"><span class="string">                  |                -&gt; php-fpm(fastcgi) -&gt; php文件 -&gt; 动态生成文件</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="通用规范"><a href="#通用规范" class="headerlink" title="通用规范"></a>通用规范</h1><h2 id="CGI"><a href="#CGI" class="headerlink" title="CGI"></a>CGI</h2><p>即 Common Gateway Interface（通用网关接口） 见 </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E9%80%9A%E7%94%A8%E7%BD%91%E5%85%B3%E6%8E%A5%E5%8F%A3">https://zh.wikipedia.org/wiki/%E9%80%9A%E7%94%A8%E7%BD%91%E5%85%B3%E6%8E%A5%E5%8F%A3</a></li>
</ul>
<h2 id="为什么要有-CGI？"><a href="#为什么要有-CGI？" class="headerlink" title="为什么要有 CGI？"></a>为什么要有 CGI？</h2><p>早期的 Web 服务器仅能访问静态网页。你所访问的所有网页内容都是提前生成好放到服务器的上的，所谓的网页访问就是读取服务器上的某个文件然后返回内容。</p>
<p>但CGI 使动态网页成为可能。</p>
<h2 id="CGI-如何实现的？"><a href="#CGI-如何实现的？" class="headerlink" title="CGI 如何实现的？"></a>CGI 如何实现的？</h2><p>通过定义一系列的通信规范来实现。</p>
<p>简而言之就是将 url、header、params 放入环境变量里，当你访问一个 CGI 文件时，Web 服务器会执行此 CGI 文件（脚本）获取输出然后返回给浏览器。你可以在 CGI 脚本中返回任意内容。</p>
<p>CGI 程序可以用任何<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%84%9A%E6%9C%AC%E8%AF%AD%E8%A8%80">脚本语言</a>或者<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80">编程语言</a>实现，只要该语言可以在系统上运行。</p>
<p>例如：<a target="_blank" rel="noopener" href="http://www.example.com/wiki.cgi">http://www.example.com/wiki.cgi</a></p>
<p>以前比较常用的是 Perl 来实现 CGI 脚本。</p>
<p>CGI环境变量示例：<a target="_blank" rel="noopener" href="https://www.runoob.com/python/python-cgi.html">https://www.runoob.com/python/python-cgi.html</a></p>
<table>
<thead>
<tr>
<th>CONTENT_TYPE</th>
<th>这个环境变量的值指示所传递来的信息的MIME类型。目前，环境变量CONTENT_TYPE一般都是：application&#x2F;x-www-form-urlencoded,他表示数据来自于HTML表单。</th>
</tr>
</thead>
<tbody><tr>
<td>CONTENT_LENGTH</td>
<td>如果服务器与CGI程序信息的传递方式是POST，这个环境变量即使从标准输入STDIN中可以读到的有效数据的字节数。这个环境变量在读取所输入的数据时必须使用。</td>
</tr>
<tr>
<td>HTTP_COOKIE</td>
<td>客户机内的 COOKIE 内容。</td>
</tr>
<tr>
<td>HTTP_USER_AGENT</td>
<td>提供包含了版本数或其他专有数据的客户浏览器信息。</td>
</tr>
<tr>
<td>PATH_INFO</td>
<td>这个环境变量的值表示紧接在CGI程序名之后的其他路径信息。它常常作为CGI程序的参数出现。</td>
</tr>
<tr>
<td>QUERY_STRING</td>
<td>如果服务器与CGI程序信息的传递方式是GET，这个环境变量的值即使所传递的信息。这个信息经常跟在CGI程序名的后面，两者中间用一个问号’?’分隔。</td>
</tr>
<tr>
<td>REMOTE_ADDR</td>
<td>这个环境变量的值是发送请求的客户机的IP地址，例如上面的192.168.1.67。这个值总是存在的。而且它是Web客户机需要提供给Web服务器的唯一标识，可以在CGI程序中用它来区分不同的Web客户机。</td>
</tr>
<tr>
<td>REMOTE_HOST</td>
<td>这个环境变量的值包含发送CGI请求的客户机的主机名。如果不支持你想查询，则无需定义此环境变量。</td>
</tr>
<tr>
<td>REQUEST_METHOD</td>
<td>提供脚本被调用的方法。对于使用 HTTP&#x2F;1.0 协议的脚本，仅 GET 和 POST 有意义。</td>
</tr>
<tr>
<td>SCRIPT_FILENAME</td>
<td>CGI脚本的完整路径</td>
</tr>
<tr>
<td>SCRIPT_NAME</td>
<td>CGI脚本的的名称</td>
</tr>
<tr>
<td>SERVER_NAME</td>
<td>这是你的 WEB 服务器的主机名、别名或IP地址。</td>
</tr>
<tr>
<td>SERVER_SOFTWARE</td>
<td>这个环境变量的值包含了调用CGI程序的HTTP服务器的名称和版本号。例如，上面的值为Apache&#x2F;2.2.14(Unix)</td>
</tr>
</tbody></table>
<h2 id="CGI-的缺点？"><a href="#CGI-的缺点？" class="headerlink" title="CGI 的缺点？"></a>CGI 的缺点？</h2><p>一般每次的 CGI 请求都需要新生成一个程序的副本来运行，这样大的工作量会很快将服务器压垮。</p>
<p>因此一些更有效的技术像 <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/w/index.php?title=Mod_perl&action=edit&redlink=1">mod_perl</a>，可以让脚本解释器直接作为模块集成在 Web 服务器（例如：<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Apache">Apache</a>）中，这样就能避免重复加载和初始化解释器。</p>
<p>不过这只是就那些需要解释器的高级语言（即解释语言，例如python）而言的，使用诸如C一类的编译语言则可以避免这种额外负荷。</p>
<p>由于C及其他编译语言的程序与解释语言程序相比，前者的运行速度更快、对操作系统的负荷更小，使用编译语言程序是可能达到更高执行效率的.</p>
<p>然而因为开发效率等原因，在目前解释型语言还是最合适的。</p>
<h2 id="FastCGI"><a href="#FastCGI" class="headerlink" title="FastCGI"></a>FastCGI</h2><p>即 FastCommon Gateway Interface（快速通用网关接口）见：<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/FastCGI">https://zh.wikipedia.org/wiki/FastCGI</a></p>
<p>为了解决 CGI 效率低下的问题而进行的改进。</p>
<p>CGI 会对每个请求创建一个进程，在请求结束时销毁。开销太大。</p>
<p>而 FastCGI 会使用进程池来处理请求，避免频繁开启进程的开销。</p>
<h1 id="特定语言实现"><a href="#特定语言实现" class="headerlink" title="特定语言实现"></a>特定语言实现</h1><h2 id="WSGI"><a href="#WSGI" class="headerlink" title="WSGI"></a>WSGI</h2><p><strong>即 Python Web Server Gateway Interface（Python Web 服务器网关接口）</strong></p>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://www.python.org/dev/peps/pep-3333/#original-rationale-and-goals-from-pep-333">https://www.python.org/dev/peps/pep-3333/</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Web%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BD%91%E5%85%B3%E6%8E%A5%E5%8F%A3">https://zh.wikipedia.org/wiki/Web%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BD%91%E5%85%B3%E6%8E%A5%E5%8F%A3</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.liaoxuefeng.com/wiki/1016959663602400/1017805733037760">https://www.liaoxuefeng.com/wiki/1016959663602400/1017805733037760</a></p>
</li>
</ul>
<p>起初是为 Python 定义的 Web 服务器与 Web 应用程序之间的接口。后来一些其他语言也参考实现了自己的 wsgi</p>
<h2 id="为什么要有WSGI？"><a href="#为什么要有WSGI？" class="headerlink" title="为什么要有WSGI？"></a>为什么要有WSGI？</h2><p>抄自PEP-3333：</p>
<blockquote>
<p>Python 当前拥有各种各样的 Web 应用程序框架，例如 Zope，Quixote，Webware，SkunkWeb，PSO 和 Twisted Web-仅举几例。对于Python的新用户来说，各种各样的选择可能是个问题，因为通常来说，他们对 Web 框架的选择将限制他们对可用 Web 服务器的选择，反之亦然。</p>
</blockquote>
<blockquote>
<p>相比之下，尽管 Java 具有许多可用的 Web 应用程序框架，但是Java的 Servlet API 使得使用任何 Java Web 应用程序框架编写的应用程序都可以在支持 Servlet API 的任何 Web 服务器中运行。</p>
</blockquote>
<h2 id="WSGI-规范的实现？"><a href="#WSGI-规范的实现？" class="headerlink" title="WSGI 规范的实现？"></a>WSGI 规范的实现？</h2><p>定义了两类对象：</p>
<ol>
<li><p><strong>Web 服务器</strong>：例如 uWSGI、gunicorn</p>
</li>
<li><p><strong>Web 应用程序</strong>：Flask、Django 的 application</p>
</li>
</ol>
<p>Web 应用程序只需要实现一个函数即可:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">application</span>(<span class="params">environ, start_response</span>):</span><br><span class="line">    start_response(<span class="string">&#x27;200 OK&#x27;</span>, [(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;text/html&#x27;</span>)])</span><br><span class="line">    <span class="keyword">return</span> [<span class="string">b&#x27;&lt;h1&gt;Hello, web!&lt;/h1&gt;&#x27;</span>]</span><br></pre></td></tr></table></figure>



<p>Web 服务器收到请求后会调用 application 函数</p>
<p>wsgi 的 environment示例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"> <span class="string">&#x27;HTTP_ACCEPT&#x27;</span>: <span class="string">&#x27;*/*&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;HTTP_ACCEPT_ENCODING&#x27;</span>: <span class="string">&#x27;gzip, deflate&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;HTTP_CONNECTION&#x27;</span>: <span class="string">&#x27;keep-alive&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;HTTP_HOST&#x27;</span>: <span class="string">&#x27;localhost:6666&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;HTTP_USER_AGENT&#x27;</span>: <span class="string">&#x27;python-requests/2.18.4&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;PATH_INFO&#x27;</span>: <span class="string">&#x27;/hello&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;QUERY_STRING&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;REMOTE_ADDR&#x27;</span>: <span class="string">&#x27;127.0.0.1&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;REMOTE_PORT&#x27;</span>: <span class="number">61415</span>,</span><br><span class="line"> <span class="string">&#x27;REQUEST_METHOD&#x27;</span>: <span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;SCRIPT_NAME&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;SERVER_NAME&#x27;</span>: <span class="string">&#x27;0.0.0.0&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;SERVER_PORT&#x27;</span>: <span class="string">&#x27;6666&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;SERVER_PROTOCOL&#x27;</span>: <span class="string">&#x27;HTTP/1.1&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;SERVER_SOFTWARE&#x27;</span>: <span class="string">&#x27;Werkzeug/0.14.1&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;werkzeug.server.shutdown&#x27;</span>: <span class="string">&#x27;&lt;function WSGIRequestHandler.make_environ.&lt;locals&gt;.shutdown_server at 0x108a02378&gt;&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;wsgi.errors&#x27;</span>: <span class="string">&quot;&lt;_io.TextIOWrapper name=&#x27;&lt;stderr&gt;&#x27; mode=&#x27;w&#x27; encoding=&#x27;UTF-8&#x27;&gt;&quot;</span>,</span><br><span class="line"> <span class="string">&#x27;wsgi.input&#x27;</span>: <span class="string">&#x27;&lt;_io.BufferedReader name=7&gt;&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;wsgi.multiprocess&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line"> <span class="string">&#x27;wsgi.multithread&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line"> <span class="string">&#x27;wsgi.run_once&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line"> <span class="string">&#x27;wsgi.url_scheme&#x27;</span>: <span class="string">&#x27;http&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;wsgi.version&#x27;</span>: (<span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="WSGI-的好处？"><a href="#WSGI-的好处？" class="headerlink" title="WSGI 的好处？"></a>WSGI 的好处？</h2><ul>
<li>如果没有的话，Web 框架就只能通过 Socket 接收原始数据，自己实现 HTTP 协议的解析。但这些事情其实是不必要的，交给专业的人来做更好。</li>
<li>一般 WSGI 服务器都是 C 写的，效率更高。</li>
<li>对 Web 框架的使用者来说，他们并不关心如何接收 HTTP 请求，也不关心如何将请求路由到具体方法处理并将响应结果返回给用户。Web 框架的使用者在大部分情况下，只需要关心如何实现业务的逻辑。</li>
</ul>
<h2 id="Flask-干了啥？"><a href="#Flask-干了啥？" class="headerlink" title="Flask 干了啥？"></a>Flask 干了啥？</h2><p>flask.Flask 的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">__call__</span>(<span class="params">self, environ, start_response</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Shortcut for :attr:`wsgi_app`.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> self.wsgi_app(environ, start_response)</span><br></pre></td></tr></table></figure>



<h2 id="Django干了啥？"><a href="#Django干了啥？" class="headerlink" title="Django干了啥？"></a>Django干了啥？</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># django.core.handlers.wsgi.py</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WSGIHandler</span>(base.BaseHandler):</span><br><span class="line">    request_class = WSGIRequest</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, *args, **kwargs</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__(*args, **kwargs)</span><br><span class="line">        self.load_middleware()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__call__</span>(<span class="params">self, environ, start_response</span>):</span><br><span class="line">        ...</span><br><span class="line">        status = <span class="string">&#x27;%d %s&#x27;</span> % (response.status_code, response.reason_phrase)</span><br><span class="line">        response_headers = [</span><br><span class="line">            *response.items(),</span><br><span class="line">            *((<span class="string">&#x27;Set-Cookie&#x27;</span>, c.output(header=<span class="string">&#x27;&#x27;</span>)) <span class="keyword">for</span> c <span class="keyword">in</span> response.cookies.values()),</span><br><span class="line">        ]</span><br><span class="line">        start_response(status, response_headers)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">getattr</span>(response, <span class="string">&#x27;file_to_stream&#x27;</span>, <span class="literal">None</span>) <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> environ.get(<span class="string">&#x27;wsgi.file_wrapper&#x27;</span>):</span><br><span class="line">            response = environ[<span class="string">&#x27;wsgi.file_wrapper&#x27;</span>](response.file_to_stream)</span><br><span class="line">        <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>

<h2 id="uwsgi-VS-uWSGI"><a href="#uwsgi-VS-uWSGI" class="headerlink" title="uwsgi VS uWSGI"></a>uwsgi VS uWSGI</h2><p>uwsgi 是一个 uWSGI 服务器的专有协议，参见</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://uwsgi-docs-zh.readthedocs.io/zh_CN/latest/Protocol.html">https://uwsgi-docs-zh.readthedocs.io/zh_CN/latest/Protocol.html</a></li>
</ul>
<p>uWSGI 是一个Web 服务器，实现了 wsgi、uwsgi 两种协议</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://uwsgi-docs-zh.readthedocs.io/zh_CN/latest/">https://uwsgi-docs-zh.readthedocs.io/zh_CN/latest/</a></li>
</ul>
<p>uWSGI 配置示例：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[uwsgi]</span></span><br><span class="line"><span class="attr">http</span> = :<span class="number">8000</span></span><br><span class="line"><span class="attr">socket</span> = <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">3031</span></span><br><span class="line"><span class="attr">wsgi-file</span> = backend/wsgi.py</span><br><span class="line"><span class="attr">callable</span> = app</span><br><span class="line"><span class="attr">chdir</span> = /opt/baelish/src</span><br><span class="line"><span class="attr">processes</span> = <span class="number">4</span></span><br><span class="line"><span class="attr">threads</span> = <span class="number">16</span></span><br><span class="line"><span class="attr">plugins</span> = python3</span><br><span class="line"><span class="attr">max-requests</span> = <span class="number">100000</span></span><br><span class="line"><span class="attr">master</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">harakiri</span>=<span class="number">30</span></span><br></pre></td></tr></table></figure>



<p>uWSGI 很复杂 有兴趣的可以研究一下</p>
<p>混淆点：</p>
<ol>
<li><p>WSGI: <strong>Python Web Server Gateway Interface</strong></p>
</li>
<li><p>uWSGI: 实现了 WSGI、uwsgi 两种协议的一个Web服务器</p>
</li>
<li><p>uwsgi: uWSGI 服务器自定义的一种协议</p>
</li>
</ol>
<h2 id="为啥我不用-uWSGI-也可以启动-Web-服务？"><a href="#为啥我不用-uWSGI-也可以启动-Web-服务？" class="headerlink" title="为啥我不用 uWSGI 也可以启动 Web 服务？"></a>为啥我不用 uWSGI 也可以启动 Web 服务？</h2><p>如果你看源码的话，会发现其实是启动了个 Python 内置的 WSGI 服务器。</p>
<h2 id="gunicore"><a href="#gunicore" class="headerlink" title="gunicore"></a>gunicore</h2><p>跟 uWSGI 同属实现了 WSGI 协议的 Web 服务器。前身是 ruby 的 unicore。</p>
<h2 id="PHP"><a href="#PHP" class="headerlink" title="PHP"></a>PHP</h2><p>php 本质上是一个 CGI 脚本。所以 PHP 写的网站都是.php结尾的文件。</p>
<p>php-fpm 是一个实现了 fastcgi 规范的进程管理服务</p>
<h1 id="Web服务器"><a href="#Web服务器" class="headerlink" title="Web服务器"></a>Web服务器</h1><h2 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h2><p>作用很多，不一一说明了。</p>
<p>1、静态文件访问功能（很优秀）</p>
<p>2、服务转发</p>
<p>3、负载均衡</p>
<p>4、虚拟主机：不同域名访问同一个IP、同一个主机上的不同服务</p>
<p>一般生产服务会使用 nginx + uwsgi + flask 部署，</p>
<p>静态文件请求使用 nginx 处理，动态请求直接转发到 uWSGI</p>
<p>那么为啥 nginx 不能直接接 flask?</p>
<ol>
<li>因为 nginx 不会 python</li>
<li>如果在 nginx 中直接用 WSGI， 那么 nginx 线程中就要启动 python 解释器，效率太低。</li>
</ol>
<h2 id="Apache"><a href="#Apache" class="headerlink" title="Apache"></a>Apache</h2><p>感觉已经过时了，不过曾经很火，因为出现的比较早，所以还有很多老系统在用。</p>
<h2 id="IIS"><a href="#IIS" class="headerlink" title="IIS"></a>IIS</h2><p>微软开发windows服务器上运行</p>
<h1 id="其他语言"><a href="#其他语言" class="headerlink" title="其他语言"></a>其他语言</h1><p>Java 现在流行内置 tomcat 了</p>
<p>php 最近也有一些内置 http server 的框架，性能远超跑 fpm 里的框架</p>
<p>ruby 版的 wsgi 叫 rack</p>
<p>go 语言则是标准库内置 http 服务</p>
<p>nodejs 也是内置 http</p>
<h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><p><a target="_blank" rel="noopener" href="https://www.python.org/dev/peps/pep-3333/#original-rationale-and-goals-from-pep-333">https://www.python.org/dev/peps/pep-3333/</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.im/post/6844904202825646093">https://juejin.im/post/6844904202825646093</a></p>
<p><a target="_blank" rel="noopener" href="http://www.nowamagic.net/academy/detail/1330211">http://www.nowamagic.net/academy/detail/1330211</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.dytttf.com/2021/11/22/%E4%B8%80%E6%AC%A1uWSGI%E6%9C%8D%E5%8A%A1%E5%93%8D%E5%BA%94500%E6%8E%92%E6%9F%A5-worker%E5%8A%A0%E8%BD%BD%E9%9A%8F%E6%9C%BA%E5%A4%B1%E8%B4%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dytttf">
      <meta itemprop="description" content="https://github.com/dytttf">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dytttf's Space">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/11/22/%E4%B8%80%E6%AC%A1uWSGI%E6%9C%8D%E5%8A%A1%E5%93%8D%E5%BA%94500%E6%8E%92%E6%9F%A5-worker%E5%8A%A0%E8%BD%BD%E9%9A%8F%E6%9C%BA%E5%A4%B1%E8%B4%A5/" class="post-title-link" itemprop="url">一次uWSGI服务响应500排查 - worker加载随机失败</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-11-22 22:15:01" itemprop="dateCreated datePublished" datetime="2021-11-22T22:15:01+08:00">2021-11-22</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>在一次线上问题排查中，发现 uWSGI 在某些情况下，会出现假僵尸进程的现象。</p>
<h1 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h1><p>服务部署很简单，常规的 Django + uWSGI 模式。</p>
<p>uWSGI 配置如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[uwsgi]</span><br><span class="line">http = :<span class="number">8888</span></span><br><span class="line">processes = <span class="number">8</span></span><br><span class="line">threads = <span class="number">1</span></span><br><span class="line">master = true</span><br><span class="line">lazy-apps = true</span><br></pre></td></tr></table></figure>

<p>在 uWSGI 的访问日志中，会夹杂一些 500 的响应，但 500 并不是因为 Django 应用代码报错产生的。</p>
<p>而是：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--- no python application found, check your startup logs <span class="keyword">for</span> errors ---</span><br><span class="line">[pid: <span class="number">1139</span>|app: -<span class="number">1</span>|req: -<span class="number">1</span>/<span class="number">720133</span>] <span class="number">10.1</span><span class="number">.0</span><span class="number">.1</span> () &#123;<span class="number">54</span> <span class="built_in">vars</span> <span class="keyword">in</span> <span class="number">1184</span> <span class="built_in">bytes</span>&#125; [Tue Nov <span class="number">16</span> <span class="number">13</span>:<span class="number">47</span>:<span class="number">19</span> <span class="number">2021</span>] POST /api/v1/test =&gt; generated <span class="number">21</span> <span class="built_in">bytes</span> <span class="keyword">in</span> <span class="number">0</span> msecs (HTTP/<span class="number">1.0</span> <span class="number">500</span>) <span class="number">2</span> headers <span class="keyword">in</span> <span class="number">83</span> <span class="built_in">bytes</span> (<span class="number">0</span> switches on core <span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>然后经过日志分析，发现 500 的请求都是由 uWSGI 的某两个固定子进程所处理的。</p>
<p>uWSGI服务一共启动了8个子进程，其中有两个子进程出现了问题，导致服务接口有 1&#x2F;4的概率调用失败。</p>
<p>那么问题来了。</p>
<ol>
<li><p>为什么会出现两个，而不是全部都有问题？</p>
</li>
<li><p>看现象是 uWSGI 的子进程的问题，为什么 uWSGI 没有自动处理这些有问题的子进程？</p>
</li>
</ol>
<h1 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h1><p>针对第一个问题，经过日志分析，定位到在 500 响应第一次出现的时间点里，发生过内存不够的现象，</p>
<p>某个请求内存不够导致了其所在 worker 的重启，但重启的时候内存还是不太够，虽然 worker 进程启</p>
<p>动成功，但在加载 Django 应用代码的时候加载失败。如下图</p>
<img src="https://images.dytttf.com/images/blog/202111222255600.png" title="uwsgi_reload_error.png">


<p>此时就出现了，某些 worker 正常， 某些 worker 异常的情况。</p>
<p>针对第二个问题，就需要去了解一下 uWSGI 的运行机制了。首先看一下在 worker 启动的时候，uWSGI 会做什么。</p>
<p>以下代码出自 uWSGI 源码：<a target="_blank" rel="noopener" href="https://github.com/unbit/uwsgi">https://github.com/unbit/uwsgi/</a></p>
<p>一个基本的调用链：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">uwsgi_init &lt;= uwsgi.main.c || core/uwsgi.c</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">	-&gt; uwsgi_setup &lt;= uwsgi.c</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">		-&gt; uwsgi_worker_run</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">			-&gt; uwsgi_init_all_apps </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">				-&gt; init_apps(uwsgi_python_init_apps) &lt;= plugins/python/python_plugin.c</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">					-&gt; init_uwsgi_app &lt;= plugins/python/pyloader.c</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">						-&gt; uwsgi_file_loader</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>



<p>关键代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// plugins/python/pyloader.c </span></span><br><span class="line"><span class="comment">// init_uwsgi_app</span></span><br><span class="line">wi-&gt;callable = up.loaders[loader](arg1);</span><br><span class="line"><span class="keyword">if</span> (!wi-&gt;callable) &#123;</span><br><span class="line">    <span class="built_in">uwsgi_log</span>(<span class="string">&quot;unable to load app %d (mountpoint=&#x27;%s&#x27;) (callable not found or import error)\n&quot;</span>, id, wi-&gt;mountpoint);</span><br><span class="line">    <span class="keyword">goto</span> doh;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">doh:</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">PyErr_Occurred</span>())</span><br><span class="line">        <span class="built_in">PyErr_Print</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br></pre></td></tr></table></figure>



<p>当 uWSGI 尝试加载 python 代码时，如果加载失败，则返回 appid 为 -1 ;</p>
<p>然后：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// core/uwsgi.c</span></span><br><span class="line"><span class="comment">// uwsgi_init_all_apps</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// no app initialized and virtualhosting enabled</span></span><br><span class="line"><span class="keyword">if</span> (uwsgi_apps_cnt == <span class="number">0</span> &amp;&amp; uwsgi.numproc &gt; <span class="number">0</span> &amp;&amp; !uwsgi.command_mode) &#123;</span><br><span class="line">    <span class="keyword">if</span> (uwsgi.need_app) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!uwsgi.lazy)</span><br><span class="line">            <span class="built_in">uwsgi_log</span>(<span class="string">&quot;*** no app loaded. GAME OVER ***\n&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (uwsgi.lazy_apps) &#123;</span><br><span class="line">            <span class="keyword">if</span> (uwsgi.master_process) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">kill</span>(uwsgi.workers[<span class="number">0</span>].pid, SIGINT)) &#123;</span><br><span class="line">                    <span class="built_in">uwsgi_error</span>(<span class="string">&quot;kill()&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">exit</span>(UWSGI_FAILED_APP_CODE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">uwsgi_log</span>(<span class="string">&quot;*** no app loaded. going in full dynamic mode ***\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当 worker 加载 app 失败时，会根据配置项决定是直接退出还是进入 dynamic 模式（默认配置）。</p>
<p>所以第二个问题的答案是: uWSGI 不认为这些进程是异常的，因此不作处理。</p>
<h1 id="优化措施"><a href="#优化措施" class="headerlink" title="优化措施"></a>优化措施</h1><p>最容易想到的一个优化措施是，在加载 app 失败的时候重试几次，但查了一下 uWSGI 的配置项后，</p>
<p>发现并没有相关选项，其实在分析代码过程中也能看出来，根本没有类似功能的代码。</p>
<p>那么只能从现有选项上着手尝试解决了。</p>
<p>先列一下涉及到的一些配置项：</p>
<ul>
<li>master: 官方文档强烈推荐开启,但关于此选项的解释又很少</li>
</ul>
<p>这里简单总结一下,启用 master 模式的话，uwsgi会启动 （1 + 1 + processes）个进程。其中第一个为 uWSGI主进程，第二个为 master 进程，专门用来管理 worker。之后会启动指定数量的 worker 进程。</p>
<p>至于为啥不用主进程来管理 worker, 这个问题我还不是很清楚。</p>
<p>master 进程的好处基本都在这里写完了：<a target="_blank" rel="noopener" href="https://uwsgi-docs-zh.readthedocs.io/zh_CN/latest/articles/TheArtOfGracefulReloading.html">https://uwsgi-docs-zh.readthedocs.io/zh_CN/latest/articles/TheArtOfGracefulReloading.html</a></p>
<p>在 master 模式下，如果 worker 进程被 KILL，那么会自动被 master 进程重启，而非 master 模式则不会，并且 worker 进程会变成僵尸进程。</p>
<ul>
<li>dynamic-apps: 所谓 dynamic 模式，就是指可以在每一个请求中附加参数来指定处理该请求的 app。</li>
</ul>
<p>uWSGI 的多个 worker 之间是可以分别加载不同的应用代码的. 参见:<a target="_blank" rel="noopener" href="https://uwsgi-docs.readthedocs.io/en/latest/DynamicApps.html">https://uwsgi-docs.readthedocs.io/en/latest/DynamicApps.html</a></p>
<ul>
<li><p>lazy-apps: 简单来说就是在 worker 进程启动完成后才开始加载 app 代码，</p>
</li>
<li><p>lazy: 同 lazy-apps，但已废弃，不推荐使用。</p>
</li>
<li><p>need-app: 如果 worker 没有加载到 app, 则直接退出。</p>
</li>
<li><p>max-requests: 设置 worker 处理的最大请求数量, 如果超过最大值则重启 worker.</p>
</li>
<li><p>max-requests-delta: 防止 worker 同时到达最大值而设置的一个差异值，会将每个 worker 的 max-requests 设置为 max-requests + ( worker_id * delta )</p>
</li>
<li><p>min-worker-lifetime: worker 重启的最小间隔描述，默认60</p>
</li>
<li><p>max-worker-lifetime: worker 将会在设置的秒数之后被重启, 默认不启用</p>
</li>
<li><p>max-worker-lifetime-delta: 类似于 max-requests-delta </p>
</li>
<li><p>worker-reload-mercy: worker 在被重启前默认的最大等待时间，worker 可以在这段时间内处理尚未完成的请求.</p>
</li>
</ul>
<p>第一种解决方式：</p>
<p>&amp;ensp;&amp;ensp;暴力一些，设置 need-app 为 true, 这样当加载失败的时候直接退出 uWSGI, 不过这个依赖于服务重启策略，如果采用 docker 部署，可以采用自动重启来保证服务稳定性。</p>
<p>第二种解决方式：</p>
<p>&amp;ensp;&amp;ensp;优雅一些, 设置 max-worker-lifetime, 这样当出现异常 worker 时，不会让异常 worker 一直处于异常的状态。</p>
<p>不同的方式其实适用于不同的场景。</p>
<p>&amp;ensp;&amp;ensp;第一种方式的影响就是在重启期间完全不可用。</p>
<p>&amp;ensp;&amp;ensp;第二种方式的影响是在 worker 异常期间有一定概率服务请求失败。</p>
<p>单纯这么比较的话，貌似第二种稍微好一点，但第一种方式其实有很多办法做到用户完全无感知的。</p>
<p>举个例子：</p>
<p>&amp;ensp;&amp;ensp;在使用 k8s 进行应用部署的时候，将后端服务部署的 Deployment 中 Pod 格式设置为大于1, 并且使用 Service 来访问后端服务，</p>
<p>这样的话，当某个后端 Pod 重启，则完全不会影响服务可用性。</p>
<p>总结一下：没有绝对通用的策略，有的只是根据应用场景设计出来的适合的策略。</p>
<h1 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h1><p>uWSGI 为何不提供一种模式来处理随机加载失败的情况呢？</p>
<p>可能的原因是：</p>
<p>1、这个场景很少，没遇到过（概率极低）</p>
<p>2、没有很完美的处理方式，比如很简单的处理方式是加载失败时重试，可设置重试次数，重试间隔等。但这个也无法保证一定可以加载成功。</p>
<p>3、存在其他手段，例如设置 worker 生存时间来处理。</p>
<h1 id="以前所不曾关注到的点"><a href="#以前所不曾关注到的点" class="headerlink" title="以前所不曾关注到的点"></a>以前所不曾关注到的点</h1><p>uWSGI 其实并不是一个简单易用的 Web 服务器，参考官方文档的定义：</p>
<blockquote>
<p>The best definition for uWSGI is “Swiss Army Knife for your network applications”.</p>
</blockquote>
<p>对 uWSGI 的最好形容是网络应用的瑞士军刀，可以应对任何情况，但前提是你得很熟悉它的用法。</p>
<p>uWSGI 并不是为 Python 而开发的，它最开始是在 Perl 语言中使用的, 而且也不叫 uWSGI.</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p>使用 uWSGI 前必读</p>
<p>&amp;ensp;&amp;ensp;<a target="_blank" rel="noopener" href="https://uwsgi-docs.readthedocs.io/en/latest/Management.html">https://uwsgi-docs.readthedocs.io/en/latest/Management.html</a></p>
<p>&amp;ensp;&amp;ensp;<a target="_blank" rel="noopener" href="https://uwsgi-docs.readthedocs.io/en/latest/FAQ.html?highlight=ProcessManagement#why-should-i-choose-uwsgi">https://uwsgi-docs.readthedocs.io/en/latest/FAQ.html?highlight=ProcessManagement#why-should-i-choose-uwsgi</a></p>
<p>&amp;ensp;&amp;ensp;<a target="_blank" rel="noopener" href="https://uwsgi-docs-zh.readthedocs.io/zh_CN/latest/articles/TheArtOfGracefulReloading.html">https://uwsgi-docs-zh.readthedocs.io/zh_CN&#x2F;latest&#x2F;articles&#x2F;TheArtOfGracefulReloading.html</a></p>
<p>github issue: </p>
<p>&amp;ensp;&amp;ensp;<a target="_blank" rel="noopener" href="https://github.com/unbit/uwsgi/issues/2374">https://github.com/unbit/uwsgi/issues/2374</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.dytttf.com/2021/11/12/IMAP%E5%8D%8F%E8%AE%AE-%E4%BB%8E%E7%BD%91%E6%98%93%E9%82%AE%E7%AE%B1%E7%9A%84%E9%AA%9A%E6%93%8D%E4%BD%9C%E5%88%B0QQ%E9%82%AE%E7%AE%B1%E7%9A%84BUG/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dytttf">
      <meta itemprop="description" content="https://github.com/dytttf">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dytttf's Space">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/11/12/IMAP%E5%8D%8F%E8%AE%AE-%E4%BB%8E%E7%BD%91%E6%98%93%E9%82%AE%E7%AE%B1%E7%9A%84%E9%AA%9A%E6%93%8D%E4%BD%9C%E5%88%B0QQ%E9%82%AE%E7%AE%B1%E7%9A%84BUG/" class="post-title-link" itemprop="url">IMAP协议-从网易邮箱的骚操作到QQ邮箱的BUG</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-11-12 21:01:43" itemprop="dateCreated datePublished" datetime="2021-11-12T21:01:43+08:00">2021-11-12</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本文主要是记录一下在使用 IMAP 协议访问网易邮箱时遇到的一个很常见的问题以及之后我是如何解决并一步一步发现 QQ 邮箱 BUG 的过程。</p>
<h1 id="发现问题"><a href="#发现问题" class="headerlink" title="发现问题"></a>发现问题</h1><p>由于工作需要，开发的系统中需要访问用户设置的邮箱内的邮件列表。我们选用的方式是采用 IMAP 协议进行读取。简化后的代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> imaplib</span><br><span class="line"></span><br><span class="line">client = imaplib.IMAP4_SSL(host=<span class="string">&quot;imap.163.com&quot;</span>, port=<span class="number">993</span>)</span><br><span class="line">client.login(<span class="string">&quot;username&quot;</span>, <span class="string">&quot;password&quot;</span>)</span><br><span class="line">client.select()</span><br></pre></td></tr></table></figure>
<p>一般邮箱都没有问题，但在访问网易邮箱时，select 命令返回的结果是：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (&#x27;NO&#x27;, [b&#x27;SELECT Unsafe Login. Please contact kefu@188.com for help&#x27;])</span></span><br></pre></td></tr></table></figure>



<h1 id="解决问题"><a href="#解决问题" class="headerlink" title="解决问题"></a>解决问题</h1><h2 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h2><p>首先，百度一下很容易就知道答案，此处不赘述。可参考文章最后的引用链接。</p>
<p>简述一下就是：</p>
<p><strong>网易邮箱服务器会检查 IMAP 客户端有没有发送 ID 命令来表明自己的身份，如果没有，则拒绝访问。</strong></p>
<p>关于 ID 命令，ID 命令的设计初衷是为了让服务器可以统计不同客户端的使用情况，但并非强制的。</p>
<p>协议中明确表示，服务器不得以 ID 命令内的信息而对客户端拒绝提供服务。</p>
<p>详细内容可参见 RFC2971 的定义：<a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc2971%E3%80%82">https://datatracker.ietf.org/doc/html/rfc2971。</a></p>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>原因知道之后，解决方案其实很简单，登陆之后再发送一个ID命令就好了。代码示例如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> imaplib</span><br><span class="line">imaplib.Commands[<span class="string">&quot;ID&quot;</span>] = <span class="string">&quot;NONAUTH&quot;</span></span><br><span class="line"></span><br><span class="line">client = imaplib.IMAP4_SSL(host=<span class="string">&quot;imap.163.com&quot;</span>, port=<span class="number">993</span>)</span><br><span class="line">client.login(<span class="string">&quot;username&quot;</span>, <span class="string">&quot;password&quot;</span>)</span><br><span class="line">client._simple_command(<span class="string">&quot;ID&quot;</span>,<span class="string">&#x27;(&quot;name&quot; &quot;test&quot; &quot;version&quot; &quot;0.0.1&quot;)&#x27;</span>)</span><br><span class="line">client.select()</span><br></pre></td></tr></table></figure>



<h1 id="引申一下"><a href="#引申一下" class="headerlink" title="引申一下"></a>引申一下</h1><p>解决方案很简单，但总感觉不够完美，少了点啥。</p>
<p>在实际应用中，用户会访问不同的邮箱的，那么就需要考虑以下两个问题：</p>
<ol>
<li><p>是否有可能某些邮箱服务器不支持 ID 命令？</p>
</li>
<li><p>如果邮箱支持 ID 命令，但并不强制使用，会对其他正常功能有影响吗？</p>
</li>
</ol>
<p>第一个问题，这个我觉得应该是有的，毕竟 ID 并非标准协议中的一部分，有可能某些邮箱服务器开发的比较早，并且无人维护了。所以针对这种情况是需要测试 IMAP 对于不认识的命令是如何处理的。</p>
<p>第二个问题，应该是不会有影响的，不过简单测试一下以求个安心。</p>
<p>于是，我先试了一下 QQ 邮箱。</p>
<p>先说第二个问题的测试结果，QQ 邮箱是没有啥影响的，这个也不重要，跳过就好。</p>
<p>但第一个问题有点出乎意料，测试方式很简单，分别向网易邮箱和 QQ 邮箱发送不支持的命令，看一下是否会影响接下来的使用即可。代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> imaplib</span><br><span class="line"></span><br><span class="line">imaplib.Debug = <span class="number">100</span></span><br><span class="line">imaplib.Commands[<span class="string">&quot;XXX&quot;</span>] = <span class="string">&quot;NONAUTH&quot;</span></span><br><span class="line"></span><br><span class="line">host = <span class="string">&quot;imap.163.com&quot;</span></span><br><span class="line"><span class="comment"># host = &quot;imap.qq.com&quot;</span></span><br><span class="line"></span><br><span class="line">client = imaplib.IMAP4_SSL(host=host, port=<span class="number">993</span>)</span><br><span class="line">client._simple_command(<span class="string">&quot;XXX&quot;</span>, <span class="string">&#x27;(&quot;name&quot; &quot;aaa&quot;)&#x27;</span>)</span><br><span class="line">client.select()</span><br></pre></td></tr></table></figure>

<p>其中网易邮箱在接收到未知命令时，返回结果是：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># b&#x27;PMGB1 BAD command not support&#x27; </span></span><br></pre></td></tr></table></figure>

<p>日志如图</p>
<img src="https://images.dytttf.com/images/blog/202111122117434.png" title='IMAP-WY-LOG.png'/>

<p>这个符合预期，直接捕获一下异常即可。</p>
<p>但 QQ 邮箱在接收到未知命令时，返回的结果是：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># b&#x27;* BAD Command!&#x27;</span></span><br></pre></td></tr></table></figure>

<p>日志如图</p>
<img src="https://images.dytttf.com/images/blog/202111122126895.png" title="IMAP-QQ-LOG.png">

<p>且代码在这里直接卡住了，等待几分钟后：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ConnectionResetError: [WinError <span class="number">10054</span>] 远程主机强迫关闭了一个现有的连接</span><br></pre></td></tr></table></figure>

<p>QQ 邮箱服务器主动断开了跟我的链接。</p>
<p>WTF ! ! !</p>
<p>网易邮箱的抛出异常，我可以直接捕获跳过即可，对程序主流程无影响。但 QQ 邮箱卡在这里是啥意思？？？</p>
<p>为了搞清楚这个事情，又开始了对代码卡住的分析。</p>
<p>代码分析过程不赘述，各种断点调试一通，最终发现，代码卡在了等待邮箱服务器返回数据的部分。</p>
<p>但从调试日志中可以看到，QQ 邮箱服务器已经返回了数据：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># b&#x27;* BAD Command!&#x27;</span></span><br></pre></td></tr></table></figure>

<p>为啥还要等呢？难道数据有问题？</p>
<p>然后又是一通搜索，在 IMAP RFC3501 定义得到了答案，其中 2.2.1 节定义了邮箱服务端的返回数据格式规范：</p>
<p>返回数据的第一部分应该是 tag、*、+ 其中之一。</p>
<ul>
<li>tag 是客户端在发送命令时携带的一个唯一标识，主要用于客户端区分收到的响应是那个命令的响应</li>
<li>* 代表此命令的相应内容尚未完结，应继续等待后续响应</li>
<li>+ 代表服务端继续等待客户端发送尚未发送完的命令</li>
</ul>
<p>因此，这里 QQ 邮箱返回的 b’* BAD Command!’ 是不对的，应该是 b’tag BAD Command!’。</p>
<p>至此，感觉已经没有什么可做的事情了。</p>
<p>不过，我还是给 QQ 邮箱发了封邮件，简单描述了一下问题，也不知道他们改不改，等结果吧。。。</p>
<p>然后我的应用代码改成了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> imaplib</span><br><span class="line"></span><br><span class="line">client = imaplib.IMAP4_SSL(host=<span class="string">&quot;imap.163.com&quot;</span>, port=<span class="number">993</span>)</span><br><span class="line">client.login(<span class="string">&quot;username&quot;</span>, <span class="string">&quot;password&quot;</span>)</span><br><span class="line">typ, dat = client.select()</span><br><span class="line"><span class="keyword">if</span> typ != <span class="string">&quot;OK&quot;</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        client._simple_command(<span class="string">&quot;ID&quot;</span>, <span class="string">&#x27;(&quot;name&quot; &quot;test&quot; &quot;version&quot; &quot;0.0.1&quot;)&#x27;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line">    typ, dat = client.select()</span><br><span class="line">    <span class="keyword">if</span> typ != <span class="string">&quot;OK&quot;</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&quot;邮箱登录失败: &#123;&#125; &#123;&#125;&quot;</span>.<span class="built_in">format</span>(typ, dat))</span><br></pre></td></tr></table></figure>



<h1 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h1><p>待回复</p>
<h1 id="不相关知识点整理"><a href="#不相关知识点整理" class="headerlink" title="不相关知识点整理"></a>不相关知识点整理</h1><ul>
<li><p>POP3 可以认为是只读的协议，客户端内的操作不会影响到服务端，只用来下载邮件</p>
</li>
<li><p>IMAP 是双向的协议，客户端的操作会反馈到服务端上，服务端也同步进行操作，不仅可以下载邮件，还可以删除，移动邮件，但不能发送邮件</p>
</li>
<li><p>SMTP 是用来发送邮件的</p>
</li>
</ul>
<h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><p><a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc2971">IMAP4 ID 扩展</a>：</p>
<p>&amp;ensp;&amp;ensp; <a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc2971">https://datatracker.ietf.org/doc/html/rfc2971</a></p>
<p><a target="_blank" rel="noopener" href="https://www.rfc-editor.org/rfc/inline-errata/rfc3501.html">IMAP4</a>：</p>
<p>&amp;ensp;&amp;ensp;<a target="_blank" rel="noopener" href="https://www.rfc-editor.org/rfc/inline-errata/rfc3501.html">https://www.rfc-editor.org/rfc/inline-errata/rfc3501.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/chjbbs/p/9858672.html">第三方邮件客户端收取163邮件问题</a>：</p>
<p>&amp;ensp;&amp;ensp;<a target="_blank" rel="noopener" href="https://www.cnblogs.com/chjbbs/p/9858672.html">https://www.cnblogs.com/chjbbs/p/9858672.html</a></p>
<p><a target="_blank" rel="noopener" href="http://help.163.com/10/0203/17/5UK7GVU100753VB9.html?servCode=6020251">IMAP 与 POP3 有什么不同？</a>：</p>
<p>&amp;ensp;&amp;ensp;<a target="_blank" rel="noopener" href="http://help.163.com/10/0203/17/5UK7GVU100753VB9.html?servCode=6020251">http://help.163.com/10/0203/17/5UK7GVU100753VB9.html?servCode=6020251</a></p>
<p><a target="_blank" rel="noopener" href="https://help.mail.163.com/faqDetail.do?code=d7a5dc8471cd0c0e8b4b8f4f8e49998b374173cfe9171305fa1ce630d7f67ac21b87735d7227c217">什么是POP3、SMTP及IMAP？</a>：</p>
<p>&amp;ensp;&amp;ensp;<a target="_blank" rel="noopener" href="https://help.mail.163.com/faqDetail.do?code=d7a5dc8471cd0c0e8b4b8f4f8e49998b374173cfe9171305fa1ce630d7f67ac21b87735d7227c217">https://help.mail.163.com/faqDetail.do?code=d7a5dc8471cd0c0e8b4b8f4f8e49998b374173cfe9171305fa1ce630d7f67ac21b87735d7227c217</a></p>
<p><a target="_blank" rel="noopener" href="https://help.mail.163.com/faqDetail.do?code=d7a5dc8471cd0c0e8b4b8f4f8e49998b374173cfe9171305fa1ce630d7f67ac211b1978002df8b23">imap连接提示Unsafe Login，被阻止的收信行为</a>：</p>
<p>&amp;ensp;&amp;ensp;<a target="_blank" rel="noopener" href="https://help.mail.163.com/faqDetail.do?code=d7a5dc8471cd0c0e8b4b8f4f8e49998b374173cfe9171305fa1ce630d7f67ac211b1978002df8b23">https://help.mail.163.com/faqDetail.do?code=d7a5dc8471cd0c0e8b4b8f4f8e49998b374173cfe9171305fa1ce630d7f67ac211b1978002df8b23</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/jony_online/article/details/108638571">Python解决的办法</a>：</p>
<p>&amp;ensp;&amp;ensp;<a target="_blank" rel="noopener" href="https://blog.csdn.net/jony_online/article/details/108638571">https://blog.csdn.net/jony_online/article/details/108638571</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">京ICP备2021028637号 </a>
  </div>

<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Dytttf</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  




  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




<script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"dytttf/dytttf.github.io","issue_term":"pathname","theme":"preferred-color-scheme"}</script>
<script src="/js/third-party/comments/utterances.js"></script>

</body>
</html>
