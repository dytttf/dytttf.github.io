<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.loli.net/css?family=Courier+Prime:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.dytttf.com","root":"/","images":"/images","scheme":"Gemini","version":"8.7.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"utterances","storage":true,"lazyload":false,"nav":null,"activeClass":"utterances"},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>
<meta name="description" content="https:&#x2F;&#x2F;github.com&#x2F;dytttf">
<meta property="og:type" content="website">
<meta property="og:title" content="Dytttf&#39;s Space">
<meta property="og:url" content="http://www.dytttf.com/page/2/">
<meta property="og:site_name" content="Dytttf&#39;s Space">
<meta property="og:description" content="https:&#x2F;&#x2F;github.com&#x2F;dytttf">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Dytttf">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://www.dytttf.com/page/2/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/2/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Dytttf's Space</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Dytttf's Space</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">There is no one</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Dytttf</p>
  <div class="site-description" itemprop="description">https://github.com/dytttf</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">25</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://kalacloud.com/" title="https:&#x2F;&#x2F;kalacloud.com" rel="noopener" target="_blank">卡拉云低代码工具</a>
        </li>
    </ul>
  </div>

          </div>
        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="Back to top">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    

  <a href="https://github.com/dytttf" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.dytttf.com/2021/09/29/GPG%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF%E7%AE%80%E4%BB%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dytttf">
      <meta itemprop="description" content="https://github.com/dytttf">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dytttf's Space">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/09/29/GPG%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF%E7%AE%80%E4%BB%8B/" class="post-title-link" itemprop="url">GPG的使用场景简介</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-09-29 21:36:55" itemprop="dateCreated datePublished" datetime="2021-09-29T21:36:55+08:00">2021-09-29</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>GPG 是一个用于加解密的命令行工具，其中包含了对一些常用的加解密场景的支持命令。</p>
<p>GPG 是 GnuPG (GnuPrivacyGuard) 的缩写。其中的 PG 是指 PGP (Pretty Good Privacy)：<br><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Pretty_Good_Privacy">https://en.wikipedia.org/wiki/Pretty_Good_Privacy</a></p>
<p>PGP 是商业用的加密软件，GPG 是<strong>自由软件基金</strong>开发的开源替代版本。</p>
<p>版本发布历史可参见官网 <a target="_blank" rel="noopener" href="https://www.gnupg.org/">https://www.gnupg.org/</a></p>
<h1 id="安装及入门用法"><a href="#安装及入门用法" class="headerlink" title="安装及入门用法"></a>安装及入门用法</h1><p>参见: <a target="_blank" rel="noopener" href="https://www.ruanyifeng.com/blog/2013/07/gpg.html">https://www.ruanyifeng.com/blog/2013/07/gpg.html</a></p>
<p>MAC 环境直接 <strong>brew install gnupg</strong></p>
<p>然后使用 gpg –version 确认安装成功以及查看版本信息</p>
<p>我当前使用版本为：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">gpg (GnuPG) 2.3.2</span><br><span class="line">libgcrypt 1.9.4</span><br><span class="line">Copyright (C) 2021 Free Software Foundation, Inc.</span><br><span class="line">License GNU GPL-3.0-or-later &lt;https://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.</span><br></pre></td></tr></table></figure>

<h1 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h1><h2 id="秘钥管理"><a href="#秘钥管理" class="headerlink" title="秘钥管理"></a>秘钥管理</h2><p>密钥管理大致包括如下几个方面：</p>
<ol>
<li>密钥生成、查看、删除、导入、导出</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成秘钥</span></span><br><span class="line">gpg --full-generate-key</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看秘钥列表</span></span><br><span class="line">gpg --list-keys --keyid-format long</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除秘钥</span></span><br><span class="line">gpg --delete-secret-keys [Key ID]</span><br><span class="line">gpg --delete-keys [Key ID]</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加子密钥</span></span><br><span class="line">gpg --quick-add-key [Key ID] rsa2048 encr</span><br><span class="line">gpg --quick-add-key [Key ID] rsa2048 sign</span><br><span class="line">gpg --quick-add-key [Key ID] rsa2048 auth</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">导入秘钥</span></span><br><span class="line">gpg --import private-key.txt</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">导出秘钥</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">公钥</span></span><br><span class="line">gpg --armor --output pub-key.txt --export [Key ID]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">私钥</span></span><br><span class="line">gpg --armor --output private-key.txt --export-secret-keys [Key ID]</span><br><span class="line">gpg --armor --output private-sub-key.txt --export-secret-subkey [Key ID]</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>密钥发布、搜索</li>
</ol>
<p>密钥发布是指将自己的公钥发布到互联网上，使得别人可以搜索下载到。公钥服务器有很多，随便找一个发布就可以。公钥服务器之间会进行公钥的互相同步。</p>
<p>推荐使用 <a target="_blank" rel="noopener" href="https://keys.openpgp.org/">https://keys.openpgp.org/</a></p>
<p>搜索时可使用他人的 Key ID（邮箱或者HASH）进行搜索</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">发布公钥</span></span><br><span class="line">gpg --keyserver hkps://keys.openpgp.org --send-keys [Key ID]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">or</span></span><br><span class="line">gpg --export [Key ID] | curl -T - https://keys.openpgp.org</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">or</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在 https://keys.openpgp.org/upload 这里上传公钥文件</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取他人公钥</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">搜索 https://keys.openpgp.org/</span></span><br><span class="line">gpg --sign-key [Key-ID]</span><br></pre></td></tr></table></figure>

<p>3、密钥注销</p>
<p>密钥注销是指声明此密钥不可用，一般可能是由于私钥泄漏、私钥密码遗忘等原因</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpg --gen-revoke --output revoke.asc [Key ID]</span><br></pre></td></tr></table></figure>



<h2 id="资源发布"><a href="#资源发布" class="headerlink" title="资源发布"></a>资源发布</h2><p>GPG 经常用于对资源进行签名，类似于校验码。</p>
<p>校验码常见的有 CRC、MD5 等，通过对资源内容做 HASH 值的计算，来确认资源内容是否被修改过。但校验码只能验证文件的完整性，是跟文件一一对应的，假如有人将文件内容和校验码同时修改了，仅使用校验码的手段是无法发现的。</p>
<p>GPG 的签名在校验时，可以同时确认文件完整性和签名所属用户，不同用户对同一文件的签名结果是不一样的。</p>
<p>举个例子：</p>
<p>在 Ubuntu 系统中使用 apt 命令安装软件，apt 会同时下载软件包和软件包的 GPG 签名，然后对软件包进行签名验证。</p>
<p>验证时会同时确认软件包的完整性和签名用户身份，只有两者都是可信的，才会信任此软件安装包并进行安装。</p>
<p>假如有人恶意将服务器上的软件包内容和签名都重新打包了，那么签名对应的用户信息必然会发生改变，校验时就能发现包被修改过。</p>
<p>完整的信任链是这样的：</p>
<ul>
<li>可信用户 -&gt; 可信签名 -&gt; 可信软件</li>
</ul>
<p>之所以不简单使用如下的信任链：</p>
<ul>
<li>可信签名 -&gt; 可信软件</li>
</ul>
<p>是因为：</p>
<ol>
<li><p>可信用户是可以枚举的，没有多少个，完全可以将可信官方的用户ID内置在系统中。</p>
</li>
<li><p>可信签名太多了，每个软件都不一样，无法枚举。</p>
</li>
</ol>
<h2 id="邮件加密"><a href="#邮件加密" class="headerlink" title="邮件加密"></a>邮件加密</h2><p>关于为什么要加密邮件，参见此网站：<a target="_blank" rel="noopener" href="https://emailselfdefense.fsf.org/en/%E3%80%82">https://emailselfdefense.fsf.org/en/。</a></p>
<p>不过目前国内可能没有这个意识或者由于其他原因并不普及。</p>
<p>邮件加密的方式有两种：</p>
<ol>
<li><p>有些邮件客户端支持GPG插件，可以自动对邮件内容进行加解密。</p>
</li>
<li><p>对于不支持的邮件客户端（国内常见的都不支持），可采用手工加密，然后将加密后的数据写进邮件发送的方式。</p>
</li>
</ol>
<h2 id="在-Git-中使用-GPG"><a href="#在-Git-中使用-GPG" class="headerlink" title="在 Git 中使用 GPG"></a>在 Git 中使用 GPG</h2><p>Git 默认使用邮件地址来确认提交者身份，但邮件地址是可以随便修改的，假如别人使用你的邮件地址做了一个提交，那么 Git 是无法识别提交的真正用户的。</p>
<p>参考 <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/76861431">https://zhuanlan.zhihu.com/p/76861431</a></p>
<p>为了防止提交被假冒，Git 引入了 GPG 签名机制。</p>
<p>基本原理如下：</p>
<ol>
<li><p>用户将自己的 GPG 公钥上传到 Git 服务器</p>
</li>
<li><p>用户在 Commit 时使用私钥对 Commit 进行签名</p>
</li>
<li><p>Git 服务器接收到 Commit 信息后，使用用户的公钥对签名进行校验，校验通过则标识为有效 Commit</p>
</li>
</ol>
<p>邮件地址可以被伪造，但签名无法被伪造，伪造者使用伪造者的私钥进行的签名不会被 Git 服务器校验通过，因为公钥不匹配。</p>
<h2 id="加解密"><a href="#加解密" class="headerlink" title="加解密"></a>加解密</h2><p>基本流程：</p>
<ol>
<li><p>使用收件用户的公钥加密文件</p>
</li>
<li><p>将加密后的文件发送为收件人</p>
</li>
<li><p>收件人使用自己的私钥解密文件</p>
</li>
</ol>
<p>加密</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpg --recipient [Key ID] --output a.encrypt.txt --encrypt a.txt</span><br></pre></td></tr></table></figure>

<p>解密</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpg --recipient [Key ID] --output a.decrypt.txt --decrypt a.encrypt.txt</span><br></pre></td></tr></table></figure>

<h2 id="签名"><a href="#签名" class="headerlink" title="签名"></a>签名</h2><p>基本流程</p>
<ol>
<li>使用自己的私钥对某个文件进行签名</li>
<li>将签名后的文件发送给收件人</li>
<li>收件人使用发送者公钥验证签名</li>
</ol>
<p>签名</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">会将文件内容和签名信息合并然后生成新的 ascii 文件</span></span><br><span class="line">gpg --clearsign a.txt</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">同上 但生成的是二进制文件</span></span><br><span class="line">gpg --sign a.txt</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成独立的签名文件</span></span><br><span class="line">gpg --detach-sign --armor a.txt</span><br></pre></td></tr></table></figure>

<p>验证签名</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpg --verify a.txt.asc</span><br></pre></td></tr></table></figure>

<h1 id="总结一下"><a href="#总结一下" class="headerlink" title="总结一下"></a>总结一下</h1><p>GPG 最重要的作用就是在加密的同时添加了加密人的信息，使得信任机制变得更有效。</p>
<h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><p>GPG 入门教程</p>
<p>&amp;ensp;&amp;ensp;<a target="_blank" rel="noopener" href="https://www.ruanyifeng.com/blog/2013/07/gpg.html">https://www.ruanyifeng.com/blog/2013/07/gpg.html</a></p>
<p>简明 GPG 概念</p>
<p>&amp;ensp;&amp;ensp;<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/137801979">https://zhuanlan.zhihu.com/p/137801979</a></p>
<p>在 Github 上使用 GPG 的全过程</p>
<p>&amp;ensp;&amp;ensp;<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/76861431">https://zhuanlan.zhihu.com/p/76861431</a></p>
<p>震惊！竟然有人在 GitHub 上冒充我的身份</p>
<p>&amp;ensp;&amp;ensp;<a target="_blank" rel="noopener" href="https://blog.spencerwoo.com/2020/08/wait-this-is-not-my-commit">https://blog.spencerwoo.com/2020/08/wait-this-is-not-my-commit</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.dytttf.com/2021/09/11/%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E7%90%86%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dytttf">
      <meta itemprop="description" content="https://github.com/dytttf">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dytttf's Space">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/09/11/%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E7%90%86%E8%A7%A3/" class="post-title-link" itemprop="url">窗口函数的一些理解</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-09-11 23:38:10" itemprop="dateCreated datePublished" datetime="2021-09-11T23:38:10+08:00">2021-09-11</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Tips:<br>&amp;ensp;&amp;ensp;MySQL 8.0以下不支持窗口函数，非要使用的话参见：<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/3333665/rank-function-in-mysql">https://stackoverflow.com/questions/3333665/rank-function-in-mysql</a></p>
<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>窗口函数，别名：开窗函数、Window函数。又称分析函数</p>
<p>常见使用场景为求排名、TopN、累加等涉及到对<strong>数据做二次处理且依赖上下文</strong>的环境的计算场景</p>
<p>历史：2003年被加入到SQL标准中，2011年的修订中添加了一些增强功能。</p>
<h2 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span>([expr]) <span class="keyword">over</span> (</span><br><span class="line">    [<span class="keyword">partition</span> <span class="keyword">by</span> partition_expr]</span><br><span class="line">    [<span class="keyword">order</span> <span class="keyword">by</span> order_expr]</span><br><span class="line">    [frame]</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>分区：分区由 partition by 子句定义。如果没有指定 partition by 子句，则整个查询与分析结果集作为一个窗口分区。</p>
<p>排序：排序由 order by 子句定义</p>
<p>框架（窗口）：框架在分区内对行进一步限制。<strong>框架元素不适用于排名函数</strong>。使用 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> <span class="keyword">start</span> <span class="keyword">AND</span> <span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>来定义，细节参见 <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/window-functions-frames.html">https://dev.mysql.com/doc/refman/8.0/en/window-functions-frames.html</a></p>
<h2 id="函数列表"><a href="#函数列表" class="headerlink" title="函数列表"></a>函数列表</h2><h4 id="专用窗口函数"><a href="#专用窗口函数" class="headerlink" title="专用窗口函数"></a>专用窗口函数</h4><ul>
<li><p><strong>row_number</strong>()	</p>
</li>
<li><ul>
<li>取行号</li>
</ul>
</li>
<li><p><strong>rank</strong>()	</p>
</li>
<li><ul>
<li>取排名 排名相同则值一样，但会占用后续排名的位置 ，   比如 1、1、1、4</li>
</ul>
</li>
<li><p><strong>dense_rank</strong>() </p>
</li>
<li><ul>
<li>取排名 排名相同则值一样，但不会占用后续排名的位置，比如 1、1、1、2 与rank()的区别见：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/92654574">https://zhuanlan.zhihu.com/p/92654574</a></li>
</ul>
</li>
<li><p><strong>percent_rank</strong>() </p>
</li>
<li><ul>
<li>计算分区内排名小于当前行的数据条数占总条数（不包含排名最高的行）的比例</li>
</ul>
</li>
<li><p><strong>cume_dist</strong>()	</p>
</li>
<li><ul>
<li>计算分区内排名小于等于当前行的数据条数占总条数的比例</li>
</ul>
</li>
<li><p><strong>lag</strong>(expr [, N[, default]])	</p>
</li>
<li><ul>
<li>返回分区内排名小于当前行的第前N行位置的值 expr 代表可以不仅仅可以取字段，也可以在取的同时对字段做操作 N默认为1 default默认为null</li>
</ul>
</li>
<li><p><strong>lead</strong>(expr [, N[, default]])	</p>
</li>
<li><ul>
<li>与lag相反，取分区内排名大于当前行的第前N行位置的值</li>
</ul>
</li>
<li><p><strong>ntitle</strong>(N)</p>
</li>
<li><ul>
<li>将分区内的数据分为N组,返回值为组序号（最小为1）</li>
</ul>
</li>
<li><p><strong>first_value</strong>(expr)</p>
</li>
<li><ul>
<li>取当前窗口范围内的第一行，lag和leag是相对位置, first_value是绝对位置，</li>
</ul>
</li>
<li><p><strong>last_value</strong>(expr)</p>
</li>
<li><ul>
<li>取当前窗口范围内的最后一行</li>
</ul>
</li>
<li><p><strong>nth_value</strong>(expr, N)</p>
</li>
<li><ul>
<li>取当前窗口范围内的第N行</li>
</ul>
</li>
</ul>
<h4 id="可用于窗口函数的聚合函数"><a href="#可用于窗口函数的聚合函数" class="headerlink" title="可用于窗口函数的聚合函数"></a>可用于窗口函数的聚合函数</h4><ul>
<li><strong>avg</strong></li>
<li><strong>count</strong></li>
<li><strong>sum</strong></li>
<li><strong>min</strong></li>
<li><strong>max</strong></li>
<li><strong>bit_and</strong></li>
<li><strong>stddev</strong>	标准差</li>
<li><strong>variance</strong>  方差</li>
<li>…</li>
</ul>
<h1 id="窗口函数与聚合函数的对比"><a href="#窗口函数与聚合函数的对比" class="headerlink" title="窗口函数与聚合函数的对比"></a>窗口函数与聚合函数的对比</h1><ol>
<li><p>两者在执行前都会对数据进行分区，窗口函数使用 PARTITION BY,聚合函数使用 GROUP BY。</p>
<p>如下图，数据被分为两个区</p>
<img src="https://images.dytttf.com/images/blog/202109112349223.png" width="15%"/>


</li>
<li><p>窗口函数相比于聚合函数多了一个窗口的概念，即分区之后又进行了一次虚拟的切分，把一个分区内的数据分成了多个窗口，并且多个窗口间数据是有重复的。</p>
<p>场景1：窗口宽度不设置，则默认为从第一行到当前行</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">	<span class="built_in">RANK</span>() <span class="keyword">OVER</span> ( </span><br><span class="line">		<span class="keyword">PARTITION</span> <span class="keyword">BY</span> `color` </span><br><span class="line">		<span class="keyword">ORDER</span> <span class="keyword">BY</span> `id`</span><br><span class="line">            # Frame 默认为空 等价于 <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> UNBOUNDED PRECEDING <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span></span><br><span class="line">		) </span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">	color_table</span><br></pre></td></tr></table></figure>

<img src="https://images.dytttf.com/images/blog/202109112356693.png" width="50%"/>

<p>场景2：窗口宽度为前后各一行</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">	<span class="built_in">RANK</span>() <span class="keyword">OVER</span> ( </span><br><span class="line">		<span class="keyword">PARTITION</span> <span class="keyword">BY</span> `color` </span><br><span class="line">		<span class="keyword">ORDER</span> <span class="keyword">BY</span> `id` </span><br><span class="line">		<span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> <span class="number">1</span> PRECEDING <span class="keyword">AND</span> <span class="number">1</span> FOLLOWING </span><br><span class="line">		) </span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">	color_table</span><br></pre></td></tr></table></figure>

<img src="https://images.dytttf.com/images/blog/202109112357665.png" width="50%" />

<p>场景3：窗口宽度为3包含前两行</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">	<span class="built_in">RANK</span>() <span class="keyword">OVER</span> ( </span><br><span class="line">		<span class="keyword">PARTITION</span> <span class="keyword">BY</span> `color` </span><br><span class="line">		<span class="keyword">ORDER</span> <span class="keyword">BY</span> `id` </span><br><span class="line">		<span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> <span class="number">2</span> PRECEDING <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span></span><br><span class="line">		) </span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">	color_table</span><br></pre></td></tr></table></figure>

<img src="https://images.dytttf.com/images/blog/202109112358107.png" width="50%" />
</li>
<li><p>窗口函数的每次操作数据范围为窗口数据的行数，移动步长为1。聚合函数的每次操作数据范围为分区数据的行数，移动步长为分区行数。</p>
<img src="https://images.dytttf.com/images/blog/202109112358150.png" width="50%"/>
</li>
<li><p>聚合函数也可以在窗口函数中使用，但作用范围缩小为对每个窗口内的数据进行聚合操作</p>
</li>
</ol>
<h1 id="窗口范围定义要点总结"><a href="#窗口范围定义要点总结" class="headerlink" title="窗口范围定义要点总结"></a>窗口范围定义要点总结</h1><h3 id="ROWS-和-RANGE-的区别"><a href="#ROWS-和-RANGE-的区别" class="headerlink" title="ROWS 和 RANGE 的区别"></a>ROWS 和 RANGE 的区别</h3><ul>
<li>ROWS：框架由开始行和结束行的位置来定义，偏移量是行号与当前行号的差异。这个比较常用。</li>
<li>RANGE：框架由值范围内的行定义，偏移量是行值与当前行值的差异。这个不太常用。</li>
</ul>
<h3 id="ORDER-BY-对窗口范围的影响"><a href="#ORDER-BY-对窗口范围的影响" class="headerlink" title="ORDER BY 对窗口范围的影响"></a>ORDER BY 对窗口范围的影响</h3><ul>
<li>没有ORDER BY, 则窗口范围是整个分区。因为没有排序，所以每一行都是对等的。</li>
<li>有ORDER BY，则窗口范围为分区内第一行到当前行。</li>
</ul>
<h3 id="窗口范围定义实例"><a href="#窗口范围定义实例" class="headerlink" title="窗口范围定义实例"></a>窗口范围定义实例</h3><ul>
<li><p>前后各N行</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> N PRECEDING <span class="keyword">AND</span> N FOLLOWING</span><br></pre></td></tr></table></figure>
</li>
<li><p>前N行到前M行</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> N PRECEDING <span class="keyword">AND</span> M PRECEDING</span><br></pre></td></tr></table></figure>
</li>
<li><p>第一行到后N行</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> UNBOUNDED PRECEDING <span class="keyword">AND</span> N FOLLOWING</span><br></pre></td></tr></table></figure>
</li>
<li><p>前N行到最后一行</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> N PRECEDING <span class="keyword">AND</span> UNBOUNDED FOLLOWING</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="使用窗口函数的一些场景"><a href="#使用窗口函数的一些场景" class="headerlink" title="使用窗口函数的一些场景"></a>使用窗口函数的一些场景</h1><p>默认数据表为 scores</p>
<table>
<thead>
<tr>
<th>id</th>
<th>name</th>
<th>value</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>Alice</td>
<td>1</td>
</tr>
<tr>
<td>2</td>
<td>Bob</td>
<td>2</td>
</tr>
<tr>
<td>3</td>
<td>Alice</td>
<td>3</td>
</tr>
<tr>
<td>4</td>
<td>Bob</td>
<td>4</td>
</tr>
</tbody></table>
<h2 id="一、求当前行值的占比"><a href="#一、求当前行值的占比" class="headerlink" title="一、求当前行值的占比"></a>一、求当前行值的占比</h2><p>利用了不排序的窗口特性</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">	<span class="operator">*</span>,</span><br><span class="line">	<span class="built_in">sum</span>( `<span class="keyword">value</span>` ) <span class="keyword">over</span> w <span class="keyword">AS</span> `sum`,</span><br><span class="line">	`<span class="keyword">value</span>` <span class="operator">/</span> <span class="built_in">sum</span>( `<span class="keyword">value</span>` ) <span class="keyword">over</span> w <span class="keyword">AS</span> `<span class="keyword">percent</span>` </span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">	scores </span><br><span class="line"><span class="keyword">WINDOW</span> w <span class="keyword">AS</span> ()</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>id</th>
<th>name</th>
<th>value</th>
<th>sum</th>
<th>percent</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>Alice</td>
<td>1</td>
<td>10</td>
<td>0.1000</td>
</tr>
<tr>
<td>2</td>
<td>Bob</td>
<td>2</td>
<td>10</td>
<td>0.2000</td>
</tr>
<tr>
<td>3</td>
<td>Alice</td>
<td>3</td>
<td>10</td>
<td>0.3000</td>
</tr>
<tr>
<td>4</td>
<td>Bob</td>
<td>4</td>
<td>10</td>
<td>0.4000</td>
</tr>
</tbody></table>
<p>二、累乘</p>
<p>使用对数+累加实现</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">	<span class="operator">*</span>,</span><br><span class="line">	<span class="built_in">power</span>(<span class="number">2</span>,</span><br><span class="line">          <span class="built_in">sum</span>(log2( `<span class="keyword">value</span>` )) <span class="keyword">OVER</span> ( <span class="keyword">ORDER</span> <span class="keyword">BY</span> `<span class="keyword">value</span>` ) </span><br><span class="line">         ) cum_multi</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">	scores</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>id</th>
<th>name</th>
<th>value</th>
<th>cum_multi</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>Alice</td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>2</td>
<td>Bob</td>
<td>2</td>
<td>2</td>
</tr>
<tr>
<td>3</td>
<td>Alice</td>
<td>3</td>
<td>6</td>
</tr>
<tr>
<td>4</td>
<td>Bob</td>
<td>4</td>
<td>24</td>
</tr>
</tbody></table>
<h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><p>mysql8.0 窗口函数文档<br>&amp;ensp;&amp;ensp;&amp;ensp;&amp;ensp;<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/window-functions.html">https://dev.mysql.com/doc/refman/8.0/en/window-functions.html</a><br>StackOverflow上关于MySQL如何实现rank()的说明<br>&amp;ensp;&amp;ensp;&amp;ensp;&amp;ensp;<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/3333665/rank-function-in-mysql">https://stackoverflow.com/questions/3333665/rank-function-in-mysql</a><br>通俗易懂的学会：SQL窗口函数<br>&amp;ensp;&amp;ensp;&amp;ensp;&amp;ensp;<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/92654574">https://zhuanlan.zhihu.com/p/92654574</a><br>维基百科：SQL<br>&amp;ensp;&amp;ensp;&amp;ensp;&amp;ensp;<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/SQL">https://zh.wikipedia.org/wiki/SQL</a><br>数据分析｜SQL窗口函数最全使用指南<br>&amp;ensp;&amp;ensp;&amp;ensp;&amp;ensp;<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/120269203">https://zhuanlan.zhihu.com/p/120269203</a><br>窗口函数<br>&amp;ensp;&amp;ensp;&amp;ensp;&amp;ensp;<a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/63972.html">https://help.aliyun.com/document_detail&#x2F;63972.html</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.dytttf.com/2021/09/02/ElasticSearch%E7%9A%84%E5%A2%9E%E9%87%8F%E5%BF%AB%E7%85%A7%E6%B5%85%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dytttf">
      <meta itemprop="description" content="https://github.com/dytttf">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dytttf's Space">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/09/02/ElasticSearch%E7%9A%84%E5%A2%9E%E9%87%8F%E5%BF%AB%E7%85%A7%E6%B5%85%E6%9E%90/" class="post-title-link" itemprop="url">ElasticSearch的增量快照浅析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-09-02 19:36:27" itemprop="dateCreated datePublished" datetime="2021-09-02T19:36:27+08:00">2021-09-02</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>&amp;ensp;&amp;ensp;ES的官方文档中关于增量快照的说明是：<br>    你的第一个快照会是一个数据的完整拷贝，但是所有后续的快照会保留的是已存快照和新数据之间的差异。</p>
<p>&amp;ensp;&amp;ensp;看到这个解释后，脑海中产生出两个疑问：</p>
<ol>
<li>删除历史快照会对新的快照造成影响吗？</li>
<li>如果每次保存的都是差异，那我的快照数据量是不是会越来越大？</li>
<li>恢复完整数据的时候要如何恢复？需要从第一个快照开始一个一个恢复吗？</li>
</ol>
<p>&amp;ensp;&amp;ensp;经过一番思考和搜索，总结一下我对这些问题的理解。</p>
<h1 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h1><p>&amp;ensp;&amp;ensp;首先，有一些关键知识点需要了解一下：</p>
<ul>
<li>ES 的底层使用了 Lucene, ES 快照实际上是对 Lucene 快照文件的一次保存。</li>
<li>Lucene 快照包含了当前时间点上与需要快照的索引相关的全部文件。</li>
<li>Lucene 的索引是由多个分段文件组成的，且分段文件是不能被修改的，只会新增和删除。</li>
<li>只有两种情况下会产生新的分段文件：1、新增、修改、删除索引内的数据 2、将已存在的分段文件合并</li>
<li>快照删除时仅删除没有被任何快照引用的文件</li>
</ul>
<h1 id="快照过程梳理"><a href="#快照过程梳理" class="headerlink" title="快照过程梳理"></a>快照过程梳理</h1><p>&amp;ensp;&amp;ensp;首次快照示意图，快照名称记为：快照 A</p>
<img src="https://images.dytttf.com/images/blog/202109022142540.png" width="50%">



<p>&amp;ensp;&amp;ensp;与快照 A 关联的文件列表为：1、2、3然后我们对ES中的数据做了一些修改，导致Lucene文件发生了一些变化。由于Lucene索引分段文件的特性，只会新增和删除而不会修改，因此此时的Lucene中文件可能如下</p>
<img src="https://images.dytttf.com/images/blog/202109022245374.png" width="30%">



<p>&amp;ensp;&amp;ensp;然后进行第二次快照，快照名称记为：快照 B</p>
<img src="https://images.dytttf.com/images/blog/202109022245338.png" width="50%">

<p>&amp;ensp;&amp;ensp;与快照 B 关联的文件列表为：2、3、4<br>&amp;ensp;&amp;ensp;然后删除快照 A</p>
<img src="https://images.dytttf.com/images/blog/202109022245358.png" width="50%">

<p>&amp;ensp;&amp;ensp;因为<br>&amp;ensp;&amp;ensp;&amp;ensp;&amp;ensp;与快照 A 关联的文件是：1、2、3<br>&amp;ensp;&amp;ensp;&amp;ensp;&amp;ensp;与快照 B 关联的文件是：2、3、4<br>&amp;ensp;&amp;ensp;所以 只有文件 1 可以被删除。</p>
<h1 id="疑问解答"><a href="#疑问解答" class="headerlink" title="疑问解答"></a>疑问解答</h1><ol>
<li><p>删除历史快照会对新的快照造成影响吗？<br>答：不会的，以上面的流程为例，只会清理不被任何快照关联的文件。而每个快照关联的文件列表都能还原当时的全量数据。</p>
</li>
<li><p>如果每次保存的都是差异，那我的快照数据量是不是会越来越大？<br>答：如果定期清理历史的快照，那么快照的数据量是不会越来越大的。虽然每次都保存的是差异，但这个差异并不是绝对的新增数据，而是对历史数据做了修改后的一个局部全量数据。也就是说，新文件和旧文件之间是有重叠数据的，所以清理历史文件即可。</p>
</li>
<li><p>恢复完整数据的时候要如何恢复？需要从第一个快照开始一个一个恢复吗？<br>答：不需要，只需恢复指定时间点的快照即可，因为每个快照都保留了那个时间点的全量数据。</p>
</li>
</ol>
<h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><p>&amp;ensp;&amp;ensp;<a target="_blank" rel="noopener" href="https://www.easyice.cn/archives/302">https://www.easyice.cn/archives/302</a></p>
<p>&amp;ensp;&amp;ensp;<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/backing-up-your-cluster.html">https://www.elastic.co/guide/cn/elasticsearch/guide/current/backing-up-your-cluster.html</a></p>
<p>&amp;ensp;&amp;ensp;<a target="_blank" rel="noopener" href="https://elasticsearch.cn/question/10818">https://elasticsearch.cn/question/10818</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.dytttf.com/2021/08/31/ClickHouse%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dytttf">
      <meta itemprop="description" content="https://github.com/dytttf">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dytttf's Space">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/08/31/ClickHouse%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85/" class="post-title-link" itemprop="url">ClickHouse集群安装</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-08-31 16:51:20" itemprop="dateCreated datePublished" datetime="2021-08-31T16:51:20+08:00">2021-08-31</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><ul>
<li>目标：ClickHouse单机集群版安装</li>
<li>本文面向ClickHouse初学者</li>
<li>服务器环境 Ubuntu18.04</li>
</ul>
<p>集群安装步骤如下：</p>
<ol>
<li>安装java</li>
<li>安装Zookeeper（依赖Java）</li>
<li>安装单机ClickHouse</li>
<li>修改ClickHouse配置为集群版</li>
</ol>
<h1 id="安装步骤"><a href="#安装步骤" class="headerlink" title="安装步骤"></a>安装步骤</h1><h2 id="一、安装Java"><a href="#一、安装Java" class="headerlink" title="一、安装Java"></a>一、安装Java</h2><p>在线安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install openjdk-8-jdk</span><br></pre></td></tr></table></figure>
<p>离线安装</p>
<ol>
<li>下载安装包：<a target="_blank" rel="noopener" href="https://www.oracle.com/cn/java/technologies/javase/javase-jdk8-downloads.html">https://www.oracle.com/cn/java/technologies/javase/javase-jdk8-downloads.html</a> 在当前页面寻找 jdk-8u301-linux-x64.tar.gz 并下载</li>
<li>将文件上传至服务器并解压到指定目录<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf jdk-8u301-linux-x64.tar.gz</span><br><span class="line"><span class="built_in">mkdir</span> /usr/local/src/jdk/</span><br><span class="line"><span class="built_in">mv</span> jdk1.8.0_301/ /usr/local/src/jdk/jdk1.8</span><br></pre></td></tr></table></figure></li>
<li>在文件 &#x2F;etc&#x2F;profile 中添加环境变量<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> JAVA_HOME=/usr/local/src/jdk/jdk1.8</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$JAVA_HOME</span>/bin</span><br><span class="line"><span class="built_in">export</span> CLASSPATH=.:<span class="variable">$JAVA_HOME</span>/lib/dt.jar:<span class="variable">$JAVA_HOME</span>/lib/tools.jar</span><br></pre></td></tr></table></figure></li>
<li>执行source &#x2F;etc&#x2F;profile 使得环境变量生效</li>
<li>使用java -version命令验证是否安装成功</li>
</ol>
<h2 id="二、安装Zookeeper"><a href="#二、安装Zookeeper" class="headerlink" title="二、安装Zookeeper"></a>二、安装Zookeeper</h2><ol>
<li>下载安装包：<a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/apache/zookeeper/zookeeper-3.7.0/apache-zookeeper-3.7.0-bin.tar.gz">https://mirrors.tuna.tsinghua.edu.cn/apache/zookeeper/zookeeper-3.7.0/apache-zookeeper-3.7.0-bin.tar.gz</a></li>
<li>将文件上传至服务器指定目录并解压<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 自定义安装路径为 /usr/local/zookeeper</span></span><br><span class="line">ZK_PATH=/usr/local/zookeeper</span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$ZK_PATH</span></span><br><span class="line">tar -zxvf apache-zookeeper-3.7.0-bin.tar.gz</span><br><span class="line"><span class="built_in">mv</span> apache-zookeeper-3.7.0-bin/* <span class="variable">$ZK_PATH</span></span><br><span class="line"><span class="comment"># 修改配置</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$ZK_PATH</span></span><br><span class="line"><span class="built_in">cp</span> conf/zoo_sample.cfg conf/zoo.cfg</span><br></pre></td></tr></table></figure></li>
<li>修改配置文件内容为如下<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tickTime=2000</span><br><span class="line">initLimit=10</span><br><span class="line">syncLimit=5</span><br><span class="line"># 主要修改dataDir属性</span><br><span class="line">dataDir=/data/zookeeper</span><br><span class="line">clientPort=2181</span><br></pre></td></tr></table></figure></li>
<li>启动服务：$ZK_PATH&#x2F;bin&#x2F;zkServer.sh start</li>
<li>此后命令如果不需要配置认证则可跳过</li>
<li>进入ZK命令行：$ZK_PATH&#x2F;bin&#x2F;zkCli.sh</li>
<li>执行添加用户命令：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">addauth digest username:password</span><br><span class="line">setAcl / auth:username:cdrwa</span><br></pre></td></tr></table></figure></li>
<li>重启zk服务：$ZK_PATH&#x2F;bin&#x2F;zkServer.sh restart</li>
</ol>
<h2 id="三、安装单机ClickHouse"><a href="#三、安装单机ClickHouse" class="headerlink" title="三、安装单机ClickHouse"></a>三、安装单机ClickHouse</h2><ol>
<li>安装CK命令如下，在安装过程中会提示输入默认用户（用户名为default）的密码<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install apt-transport-https ca-certificates dirmngr</span><br><span class="line">sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv E0C56BD4</span><br><span class="line"><span class="comment"># 此处使用清华源 加快安装速度</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;deb https://mirrors.tuna.tsinghua.edu.cn/clickhouse/deb/stable/ main/&quot;</span> | sudo <span class="built_in">tee</span> /etc/apt/sources.list.d/clickhouse.list</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install -y clickhouse-server clickhouse-client</span><br><span class="line">sudo service clickhouse-server start</span><br></pre></td></tr></table></figure></li>
<li>安装完成进行登录测试：clickhouse-client -u default –password password</li>
</ol>
<h2 id="四、修改ClickHouse配置为集群版"><a href="#四、修改ClickHouse配置为集群版" class="headerlink" title="四、修改ClickHouse配置为集群版"></a>四、修改ClickHouse配置为集群版</h2><ol>
<li>备份默认配置文件：cp &#x2F;etc&#x2F;clickhouse-server&#x2F;config.xml &#x2F;etc&#x2F;clickhouse-server&#x2F;config.xml.bak</li>
<li>然后编辑默认配置文件  &#x2F;etc&#x2F;clickhouse-server&#x2F;config.xml 并删除集群相关的配置<blockquote>
<p>文件中 remote_servers、zookeeper、macros 标签里的全部内容</p>
</blockquote>
</li>
<li>添加自定义配置文件：vi &#x2F;etc&#x2F;clickhouse-server&#x2F;config.d&#x2F;config.xml 内容如下<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">yandex</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">zookeeper</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">node</span> <span class="attr">index</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">host</span>&gt;</span>此处改为ZK的HOST<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">port</span>&gt;</span>2181<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">identity</span>&gt;</span>zk_username:zk_password<span class="tag">&lt;/<span class="name">identity</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">session_timeout_ms</span>&gt;</span>600000<span class="tag">&lt;/<span class="name">session_timeout_ms</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">zookeeper</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="tag">&lt;<span class="name">remote_servers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">test</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">shard</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">internal_replication</span>&gt;</span>true<span class="tag">&lt;/<span class="name">internal_replication</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">replica</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">host</span>&gt;</span>本机IP<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">port</span>&gt;</span>9000<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">user</span>&gt;</span>default<span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">password</span>&gt;</span>password<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">shard</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">test</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">remote_servers</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="tag">&lt;<span class="name">networks</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ip</span>&gt;</span>::/0<span class="tag">&lt;/<span class="name">ip</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">networks</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">macros</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">shard</span>&gt;</span>01<span class="tag">&lt;/<span class="name">shard</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">replica</span>&gt;</span>node1<span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">macros</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">yandex</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="关键步骤解释"><a href="#关键步骤解释" class="headerlink" title="关键步骤解释"></a>关键步骤解释</h1><h2 id="集群配置文件解释"><a href="#集群配置文件解释" class="headerlink" title="集群配置文件解释"></a>集群配置文件解释</h2><h3 id="zookeeper-配置"><a href="#zookeeper-配置" class="headerlink" title="zookeeper 配置"></a>zookeeper 配置</h3><ol>
<li>如果Zookeeper为集群版，直接增加node节点即可</li>
</ol>
<h3 id="remote-servers-配置"><a href="#remote-servers-配置" class="headerlink" title="remote_servers 配置"></a>remote_servers 配置</h3><ol>
<li>remote_servers下级节点为集群，可配置多个集群</li>
<li>集群下级节点为分片（shard），可配置多个shard，不同shard不能用同一个ClickHouse实例</li>
<li>分片下级为副本（replica），可对分片配置多个副本，默认最少0个，不同副本不能用同一个ClickHouse实例</li>
<li>internal_replication 用来控制当数据写入时（必须是Replicated*的表），由分片自己负责副本间的数据复制，否则分布式表的副本数据写入需要由Distributed引擎来负责</li>
</ol>
<h3 id="macros-配置"><a href="#macros-配置" class="headerlink" title="macros 配置"></a>macros 配置</h3><ol>
<li>参数解释 <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/68272747/what-is-macros-in-clickhouse-and-what-is-use-of-macros-in-clickhouse">https://stackoverflow.com/questions/68272747/what-is-macros-in-clickhouse-and-what-is-use-of-macros-in-clickhouse</a></li>
<li>本质上就是针对当前实例的全局变量的定义，可以被某些地方来引用</li>
<li>此配置需要在集群中全局唯一</li>
<li>此处的参数会在创建Replicated*的表时被引用</li>
<li>shard的值为当前节点在在集群中的分片编号，需要在集群中唯一</li>
<li>replica是副本的唯一标识，需要在单个分片的多个副本中唯一</li>
</ol>
<h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><p>ClickHouse官方文档：</p>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://clickhouse.tech/docs/zh/getting-started/install/">https://clickhouse.tech/docs/zh/getting-started/install/</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://clickhouse.tech/docs/zh/getting-started/tutorial/">https://clickhouse.tech/docs/zh/getting-started/tutorial/</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://clickhouse.tech/docs/en/engines/table-engines/mergetree-family/replication/#creating-replicated-tables">https://clickhouse.tech/docs/en/engines/table-engines/mergetree-family/replication/#creating-replicated-tables</a></p>
</li>
</ul>
<p>StackOverFlow关于macros的解释</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/68272747/what-is-macros-in-clickhouse-and-what-is-use-of-macros-in-clickhouse">https://stackoverflow.com/questions/68272747/what-is-macros-in-clickhouse-and-what-is-use-of-macros-in-clickhouse</a></li>
</ul>
<p>一本书</p>
<ul>
<li>《ClickHouse原理解析与应用实践》</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.dytttf.com/2020/07/22/python%E7%9A%84collections%E5%BA%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dytttf">
      <meta itemprop="description" content="https://github.com/dytttf">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dytttf's Space">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/07/22/python%E7%9A%84collections%E5%BA%93/" class="post-title-link" itemprop="url">python的collections库</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-07-22 00:10:38" itemprop="dateCreated datePublished" datetime="2020-07-22T00:10:38+08:00">2020-07-22</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>用了这么长时间的python，一直觉得collections库里面的东西真是太好用了，然而发现很多人竟然还没听过，忍不住想安利一下。</p>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>collections是python标准库中的一员。官方文档解释为：Container datatypes。提供了对python的基础（容器）数据类型dict、list、set、tuple的替代选择。</p>
<blockquote>
<p>模块内成员有：</p>
</blockquote>
<ul>
<li>namedtuple  # 命名元组</li>
<li>deque # 双端队列</li>
<li>ChainMap # 链式字典</li>
<li>Counter # 计数器</li>
<li>OrderedDict # 有序字典</li>
<li>defaultdict # 默认值字典</li>
<li>UserDict</li>
<li>UserList</li>
<li>UserString</li>
</ul>
<h2 id="namedtuple（命名元组）"><a href="#namedtuple（命名元组）" class="headerlink" title="namedtuple（命名元组）"></a>namedtuple（命名元组）</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">collections.namedtuple(typename, field_names, *, rename=False, defaults=None, module=None)</span><br></pre></td></tr></table></figure>
<h3 id="导入"><a href="#导入" class="headerlink" title="导入"></a>导入</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">from collections import namedtuple</span><br></pre></td></tr></table></figure>
<h3 id="创建"><a href="#创建" class="headerlink" title="创建"></a>创建</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Point = namedtuple(&#x27;Point&#x27;, [&#x27;x&#x27;, &#x27;y&#x27;])</span><br><span class="line"># 文档字符串查看</span><br><span class="line">print(Point.__doc__)                 </span><br><span class="line"># &gt;&gt;&gt; &#x27;Point(x, y)&#x27;</span><br><span class="line">p = Point(11, y=22) </span><br></pre></td></tr></table></figure>
<h3 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 类tuple操作</span><br><span class="line">print(p[0] + p[1])</span><br><span class="line"># &gt;&gt;&gt; 33</span><br><span class="line"></span><br><span class="line"># 解包</span><br><span class="line">x, y = p</span><br><span class="line">print(x, y)</span><br><span class="line"># &gt;&gt;&gt; (11, 22)</span><br><span class="line"></span><br><span class="line"># 属性访问</span><br><span class="line">print(p.x)</span><br><span class="line"># &gt;&gt;&gt; 11</span><br></pre></td></tr></table></figure>
<h3 id="用途"><a href="#用途" class="headerlink" title="用途"></a>用途</h3><blockquote>
<p>因为namedtuple更节省内存</p>
</blockquote>
<ol>
<li>代替某些仅需要访问数据的类<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">class Stock(object):</span><br><span class="line">	def __init__(self,name,shares,price):</span><br><span class="line">		self.name = name</span><br><span class="line">		self.shares = shares</span><br><span class="line">		self.price = price</span><br><span class="line"># or </span><br><span class="line">import collections</span><br><span class="line">Stock = collections.namedtuple(&#x27;Stock&#x27;,&#x27;name shares price&#x27;)</span><br></pre></td></tr></table></figure></li>
<li>代替不需要改变的字典</li>
</ol>
<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><h4 id="1-为啥会节省内存？"><a href="#1-为啥会节省内存？" class="headerlink" title="1.为啥会节省内存？"></a>1.为啥会节省内存？</h4><p>TODO</p>
<h4 id="2-如何实现的属性访问？"><a href="#2-如何实现的属性访问？" class="headerlink" title="2.如何实现的属性访问？"></a>2.如何实现的属性访问？</h4><p>查看源码，发现其实就是给每个参数做了个别名，实质还是通过索引去访问数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">print(p._source)</span><br><span class="line">&#x27;&#x27;&#x27;</span><br><span class="line">class Point(tuple):</span><br><span class="line">    &#x27;Point(x, y)&#x27;</span><br><span class="line">    __slots__ = ()</span><br><span class="line">    _fields = (&#x27;x&#x27;, &#x27;y&#x27;)</span><br><span class="line">    def __new__(_cls, x, y):</span><br><span class="line">        &#x27;Create new instance of Point(x, y)&#x27;</span><br><span class="line">        return _tuple.__new__(_cls, (x, y))</span><br><span class="line">    ...</span><br><span class="line">    x = _property(_itemgetter(0), doc=&#x27;Alias for field number 0&#x27;)</span><br><span class="line">    y = _property(_itemgetter(1), doc=&#x27;Alias for field number 1&#x27;)</span><br><span class="line"></span><br><span class="line">&#x27;&#x27;&#x27;</span><br></pre></td></tr></table></figure>

<h2 id="deque（双端队列）"><a href="#deque（双端队列）" class="headerlink" title="deque（双端队列）"></a>deque（双端队列）</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">class collections.deque([iterable[, maxlen]])</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Deque队列是由栈或者queue队列生成的（发音是 “deck”，”double-ended queue”的简称）。Deque 支持线程安全，内存高效添加(append)和弹出(pop)，从两端都可以，两个方向的大概开销都是 O(1) 复杂度。</p>
</blockquote>
<blockquote>
<p>虽然 list 对象也支持类似操作，不过这里优化了定长操作和 pop(0) 和 insert(0, v) 的开销。它们引起 O(n) 内存移动的操作，改变底层数据表达的大小和位置。</p>
</blockquote>
<blockquote>
<p>如果 maxlen 没有指定或者是 None ，deques 可以增长到任意长度。否则，deque就限定到指定最大长度。一旦限定长度的deque满了，当新项加入时，同样数量的项就从另一端弹出。限定长度deque提供类似Unix filter tail 的功能。它们同样可以用与追踪最近的交换和其他数据池活动。</p>
</blockquote>
<h3 id="创建-1"><a href="#创建-1" class="headerlink" title="创建"></a>创建</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">test_deque = collections.deque([1, 2, 3, 4], 1000)</span><br></pre></td></tr></table></figure>
<h3 id="用法-1"><a href="#用法-1" class="headerlink" title="用法"></a>用法</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">from collections import deque</span><br><span class="line"></span><br><span class="line">test_deque = deque()</span><br><span class="line">test_deque.append(1)</span><br><span class="line">test_deque.append(2)</span><br><span class="line">test_deque.append(3)</span><br><span class="line">test_deque.appendleft(0)</span><br><span class="line"># &gt;&gt;&gt; deque([0, 1, 2, 3])</span><br><span class="line"></span><br><span class="line">test_deque.pop()</span><br><span class="line"># &gt;&gt;&gt; deque([0, 1, 2])</span><br><span class="line"></span><br><span class="line">test_deque.popleft()</span><br><span class="line"># &gt;&gt;&gt; deque([1, 2])</span><br></pre></td></tr></table></figure>

<h3 id="用途-1"><a href="#用途-1" class="headerlink" title="用途"></a>用途</h3><ol>
<li>deque特点在于双端操作速度都快，如果要将数据插入列表头部或者从头部提取数据（保持处理顺序）则使用deque能够提升很大效率</li>
<li>deque支持限制队列长度，在某些类型的应用，比如保留1000条日志时很有用。</li>
</ol>
<h3 id="性能测试结果"><a href="#性能测试结果" class="headerlink" title="性能测试结果"></a>性能测试结果</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"># coding:utf8</span><br><span class="line">import time</span><br><span class="line">from concurrent.futures import ThreadPoolExecutor</span><br><span class="line">from collections import deque</span><br><span class="line"></span><br><span class="line">pool = ThreadPoolExecutor(100)</span><br><span class="line"></span><br><span class="line">data_length = 100000</span><br><span class="line"></span><br><span class="line"># 测试</span><br><span class="line">def test(_type):</span><br><span class="line">    start = time.time()</span><br><span class="line"></span><br><span class="line">    if _type == &quot;list&quot;:</span><br><span class="line">        l = []</span><br><span class="line"></span><br><span class="line">        def work(i):</span><br><span class="line">            l.insert(0, i)</span><br><span class="line"></span><br><span class="line">    elif _type == &quot;deque&quot;:</span><br><span class="line">        l = deque()</span><br><span class="line"></span><br><span class="line">        def work(i):</span><br><span class="line">            l.appendleft(i)</span><br><span class="line"></span><br><span class="line">    r = list(pool.map(work, range(data_length)))</span><br><span class="line">    print(f&quot;&#123;_type&#125;: &#123;time.time() - start&#125;&quot;)</span><br><span class="line">    return</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">test(&quot;deque&quot;)</span><br><span class="line">test(&quot;list&quot;)</span><br><span class="line"></span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">deque: 3.510190725326538</span><br><span class="line">list: 6.319669008255005</span><br><span class="line">&quot;&quot;&quot;</span><br></pre></td></tr></table></figure>

<h2 id="ChainMap"><a href="#ChainMap" class="headerlink" title="ChainMap"></a>ChainMap</h2><blockquote>
<p>一个 ChainMap 将多个字典或者其他映射组合在一起，创建一个单独的可更新的视图。 如果没有 maps 被指定，就提供一个默认的空字典，这样一个新链至少有一个映射。</p>
</blockquote>
<h3 id="创建-2"><a href="#创建-2" class="headerlink" title="创建"></a>创建</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">from collections import ChainMap</span><br><span class="line"></span><br><span class="line">cm = ChainMap(&#123;1: 1&#125;, &#123;2: 2&#125;, &#123;3: 3&#125;)</span><br><span class="line"></span><br><span class="line">print(cm[1])</span><br><span class="line"># &gt;&gt;&gt; 1</span><br><span class="line">print(cm[2])</span><br><span class="line"># &gt;&gt;&gt; 2</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="用途-2"><a href="#用途-2" class="headerlink" title="用途"></a>用途</h3><ol>
<li>模拟python内部lookup链<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import builtins</span><br><span class="line">pylookup = ChainMap(locals(), globals(), vars(builtins))</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="Counter"><a href="#Counter" class="headerlink" title="Counter"></a>Counter</h2><blockquote>
<p>一个计数器工具提供快速和方便的计数</p>
</blockquote>
<h3 id="创建-3"><a href="#创建-3" class="headerlink" title="创建"></a>创建</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">from collections import Counter</span><br><span class="line">c = Counter(&quot;aaacccddd&quot;)</span><br><span class="line">c = Counter([&quot;a&quot;, &quot;a&quot;, &quot;b&quot;, &quot;c&quot;, &quot;d&quot;])</span><br></pre></td></tr></table></figure>
<h3 id="用法-2"><a href="#用法-2" class="headerlink" title="用法"></a>用法</h3><ol>
<li>计数<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">c = Counter([&quot;a&quot;, &quot;a&quot;, &quot;b&quot;, &quot;c&quot;, &quot;d&quot;])</span><br><span class="line"># &gt;&gt;&gt; Counter(&#123;&#x27;a&#x27;: 2, &#x27;b&#x27;: 1, &#x27;c&#x27;: 1, &#x27;d&#x27;: 1&#125;)</span><br><span class="line">c += Counter([&quot;a&quot;, &quot;a&quot;, &quot;b&quot;, &quot;c&quot;, &quot;d&quot;])</span><br><span class="line"># &gt;&gt;&gt; Counter(&#123;&#x27;a&#x27;: 4, &#x27;b&#x27;: 2, &#x27;c&#x27;: 2, &#x27;d&#x27;: 2&#125;)</span><br><span class="line">c -= Counter([&quot;a&quot;, &quot;a&quot;, &quot;b&quot;, &quot;c&quot;, &quot;d&quot;])</span><br><span class="line"># &gt;&gt;&gt; Counter(&#123;&#x27;a&#x27;: 2, &#x27;b&#x27;: 1, &#x27;c&#x27;: 1, &#x27;d&#x27;: 1&#125;)</span><br></pre></td></tr></table></figure></li>
<li>统计重复最多的元素<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">c = Counter([&quot;a&quot;, &quot;a&quot;, &quot;b&quot;, &quot;c&quot;, &quot;d&quot;])</span><br><span class="line">c.most_common(1)</span><br><span class="line"># &gt;&gt;&gt; [(&#x27;a&#x27;, 4)]</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="defaultdict"><a href="#defaultdict" class="headerlink" title="defaultdict"></a>defaultdict</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">class collections.defaultdict([default_factory[, ...]])</span><br></pre></td></tr></table></figure>
<blockquote>
<p>返回一个新的类似字典的对象。 defaultdict 是内置 dict 类的子类。它重载了一个方法并添加了一个可写的实例变量</p>
</blockquote>
<h3 id="创建-4"><a href="#创建-4" class="headerlink" title="创建"></a>创建</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">from collections import defaultdict</span><br><span class="line"></span><br><span class="line">d = defaultdict(int)</span><br><span class="line">print(d[&quot;xxx&quot;])</span><br><span class="line"># &gt;&gt;&gt; 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">d = defaultdict(dict)</span><br><span class="line">print(d[&quot;xxx&quot;])</span><br><span class="line"># &gt;&gt;&gt; &#123;&#125;</span><br><span class="line"></span><br><span class="line">d = defaultdict(lambda: defaultdict(int))</span><br><span class="line">print(d[&quot;xxx&quot;][&quot;xxx&quot;])</span><br><span class="line"># &gt;&gt;&gt; 0</span><br><span class="line"></span><br><span class="line">d = defaultdict(lambda: defaultdict(lambda: defaultdict(lambda: defaultdict(int))))</span><br><span class="line">print(d[&quot;xxx&quot;][&quot;xxx&quot;][&quot;xxx&quot;][&quot;xxx&quot;])</span><br><span class="line"># &gt;&gt;&gt; 0</span><br></pre></td></tr></table></figure>
<h3 id="用法-3"><a href="#用法-3" class="headerlink" title="用法"></a>用法</h3><ol>
<li><p>提供默认值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">d = defaultdict(int)</span><br><span class="line">print(d[&quot;xxx&quot;])</span><br><span class="line"># &gt;&gt;&gt; 0</span><br><span class="line"></span><br><span class="line">d = &#123;&#125;</span><br><span class="line">print(d.get(&quot;xxx&quot;, 0))</span><br><span class="line"># &gt;&gt;&gt; 0</span><br></pre></td></tr></table></figure>

</li>
<li><p>对多层嵌套数据结构提供默认值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 预定义数据结构</span><br><span class="line">d = defaultdict(lambda: &#123;&quot;name&quot;: &quot;&quot;, &quot;child&quot;: defaultdict(str)&#125;)</span><br><span class="line"></span><br><span class="line">print(d[&quot;xxx&quot;][&quot;child&quot;][&quot;tom&quot;])</span><br></pre></td></tr></table></figure>
</li>
<li><p>省去if判断</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">d = defaultdict(list)</span><br><span class="line">d[&quot;name&quot;].append(&quot;xxx&quot;)</span><br><span class="line">d[&quot;age&quot;].append(&quot;111&quot;)</span><br><span class="line">print(d)</span><br><span class="line"># &gt;&gt;&gt; defaultdict(&lt;class &#x27;list&#x27;&gt;, &#123;&#x27;name&#x27;: [&#x27;xxx&#x27;], &#x27;age&#x27;: [&#x27;111&#x27;]&#125;)</span><br><span class="line"></span><br><span class="line">d = &#123;&#125;</span><br><span class="line">if &quot;name&quot; not in d:</span><br><span class="line">    d[&quot;name&quot;] = []</span><br><span class="line">d[&quot;name&quot;].append(&quot;xxx&quot;)</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.dytttf.com/2020/07/04/mysql%E7%94%A8%E6%88%B7%E5%8F%8A%E6%9D%83%E9%99%90%E5%A4%8D%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dytttf">
      <meta itemprop="description" content="https://github.com/dytttf">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dytttf's Space">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/07/04/mysql%E7%94%A8%E6%88%B7%E5%8F%8A%E6%9D%83%E9%99%90%E5%A4%8D%E5%88%B6/" class="post-title-link" itemprop="url">mysql用户及权限复制</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-07-04 20:32:39" itemprop="dateCreated datePublished" datetime="2020-07-04T20:32:39+08:00">2020-07-04</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>由于某些很坑的原因，需要将一台mysql里的全部数据进行迁移，并且需要迁移用户及权限。下面记录下用户及权限是如何迁移的。</p>
<h1 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h1><p>首先，我没找到现成的工具。。。因此只好自己搞了，好在也没多复杂。</p>
<h2 id="用户迁移"><a href="#用户迁移" class="headerlink" title="用户迁移"></a>用户迁移</h2><p>mysql里的用户都存在于mysql.user这张表里。可以通过SQL查询这张表拿到host、user、authentication_string（加密后的密码）。</p>
<p>然后通过SQL在新库中创建用户，并更新新库中的mysql.user表里的authentication_string字段。这样就不需要知道账号的明文密码了。</p>
<p><strong>需要注意的是，修改完mysql.user表中的加密密码字段后，需要执行</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FLUSH PRIVILEGES</span><br></pre></td></tr></table></figure>
<p><strong>然后新的密码才能生效</strong></p>
<h2 id="权限迁移"><a href="#权限迁移" class="headerlink" title="权限迁移"></a>权限迁移</h2><p>利用SQL语句</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW GRANTS FOR &#x27;user&#x27;@&#x27;host&#x27;;</span><br></pre></td></tr></table></figure>
<p>可查询指定用户被授权过的权限，得到的直接就是一条授权语句。将此授权语句在新库中执行即可</p>
<p><strong>需要注意的是授权语句中如果有针对某个表的授权，那么当表不存在时会报错，因此授权的迁移只能放在数据的迁移之后</strong></p>
<h1 id="完整示例脚本"><a href="#完整示例脚本" class="headerlink" title="完整示例脚本"></a>完整示例脚本</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"># coding:utf8</span><br><span class="line">import pymysql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">source_mysql_client = pymysql.connect(</span><br><span class="line">    host=None, user=None, password=&quot;&quot;, database=None, port=3306</span><br><span class="line">)</span><br><span class="line">source_mysql_client.autocommit(True)</span><br><span class="line">source_mysql_cursor = source_mysql_client.cursor()</span><br><span class="line"></span><br><span class="line">target_mysql_client = pymysql.connect(</span><br><span class="line">    host=None, user=None, password=&quot;&quot;, database=None, port=3306</span><br><span class="line">)</span><br><span class="line">target_mysql_client.autocommit(True)</span><br><span class="line">target_mysql_cursor = target_mysql_client.cursor()</span><br><span class="line"></span><br><span class="line"># 需要忽略的用户</span><br><span class="line">ignore_users = [&quot;mysql.session&quot;, &quot;root&quot;, &quot;mysql.sys&quot;]</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line">target_sql_list = []</span><br><span class="line"></span><br><span class="line">sql = &quot;select host, user, authentication_string from mysql.user&quot;</span><br><span class="line">source_mysql_cursor.execute(sql)</span><br><span class="line"></span><br><span class="line">for host, user, authentication_string in source_mysql_cursor.fetchall():</span><br><span class="line">    if user in ignore_users:</span><br><span class="line">        continue</span><br><span class="line">    # 创建用户</span><br><span class="line">    create_sql = &quot;CREATE USER IF NOT EXISTS &#x27;&#123;&#125;&#x27;@&#x27;&#123;&#125;&#x27; IDENTIFIED BY &#x27;skvnajnvr92jkfads&#x27;&quot;.format(</span><br><span class="line">        user, host</span><br><span class="line">    )</span><br><span class="line">    # 修改密码</span><br><span class="line">    change_password_sql = &quot;UPDATE mysql.user SET authentication_string=&#x27;&#123;&#125;&#x27; WHERE host=&#x27;&#123;&#125;&#x27; AND user=&#x27;&#123;&#125;&#x27;&quot;.format(</span><br><span class="line">        authentication_string, host, user</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    target_sql_list.append(create_sql)</span><br><span class="line">    target_sql_list.append(change_password_sql)</span><br><span class="line"></span><br><span class="line">    # 授权语句获取</span><br><span class="line">    grant_sql = &quot;show grants for &#x27;&#123;&#125;&#x27;@&#x27;&#123;&#125;&#x27;&quot;.format(user, host)</span><br><span class="line">    source_mysql_cursor.execute(grant_sql)</span><br><span class="line">    grant_sql_result = source_mysql_cursor.fetchall()</span><br><span class="line">    target_sql_list.extend([x[0] for x in grant_sql_result])</span><br><span class="line"></span><br><span class="line">source_mysql_cursor.close()</span><br><span class="line">source_mysql_client.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#</span><br><span class="line">target_sql_list.append(&quot;FLUSH PRIVILEGES&quot;)</span><br><span class="line">for sql in target_sql_list:</span><br><span class="line">    r = target_mysql_cursor.execute(sql)</span><br><span class="line">    print(sql)</span><br><span class="line">    print(r)</span><br><span class="line"></span><br><span class="line">target_mysql_cursor.close()</span><br><span class="line">target_mysql_client.close()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.dytttf.com/2020/06/25/%E4%BD%A0%E8%BF%98%E8%AE%B0%E5%BE%97%E9%9A%8F%E6%89%8B%E6%94%B6%E8%97%8F%E7%9A%84%E8%B5%84%E6%BA%90%E5%92%8C%E7%BD%91%E9%A1%B5%E5%9C%A8%E5%93%AA%E9%87%8C%E5%90%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dytttf">
      <meta itemprop="description" content="https://github.com/dytttf">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dytttf's Space">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/06/25/%E4%BD%A0%E8%BF%98%E8%AE%B0%E5%BE%97%E9%9A%8F%E6%89%8B%E6%94%B6%E8%97%8F%E7%9A%84%E8%B5%84%E6%BA%90%E5%92%8C%E7%BD%91%E9%A1%B5%E5%9C%A8%E5%93%AA%E9%87%8C%E5%90%97/" class="post-title-link" itemprop="url">你还记得随手收藏的资源和网页在哪里吗</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-06-25 23:52:34" itemprop="dateCreated datePublished" datetime="2020-06-25T23:52:34+08:00">2020-06-25</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><em>清理浏览器书签有感而发</em></p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>平时浏览些网站、看些博客、查点问题的时候，总是随手会加个书签。偶尔心血来潮的时候，还会建个目录，收集一系列相关文章、资料。</p>
<p>然而，等你真的碰到了问题的时候，你根本想不起来到书签里、笔记里去找答案。</p>
<p>除非，这个笔记是你自己写的，而非随手收藏的。</p>
<p>网盘里的数T各种视频、文档，根本不会去看。</p>
<p>今天突然看到了自己的书签好乱，整理了一下，发现好多东西都可以删掉了。</p>
<h1 id="删删删"><a href="#删删删" class="headerlink" title="删删删"></a>删删删</h1><h3 id="某些网站的首页"><a href="#某些网站的首页" class="headerlink" title="某些网站的首页"></a>某些网站的首页</h3><blockquote>
<p>唉、不知道当时为啥要存这个东西，还单独建了个文件夹。难道百度不香吗？</p>
</blockquote>
<ul>
<li>CSDN</li>
<li>StackOverflow</li>
<li>SegmentFault</li>
<li>Ruby</li>
<li>ubuntu中文论坛</li>
<li>O’reilly</li>
<li>WebSpidersScreenScrapers</li>
<li>小程序</li>
<li>账号网</li>
<li>豌豆荚</li>
<li>图灵</li>
<li>shadon</li>
<li>开源中国</li>
<li></li>
<li>梦幻西游</li>
</ul>
<h3 id="某些已经不需要了的东西"><a href="#某些已经不需要了的东西" class="headerlink" title="某些已经不需要了的东西"></a>某些已经不需要了的东西</h3><ul>
<li>Sublime的相关教程<blockquote>
<p>专业编辑器很香。不过Sublime的多行编辑操作很爽，一直在用</p>
</blockquote>
</li>
<li>Vim的相关教程<blockquote>
<p>曾经也是重度用户，不过现在感觉会简单操作就可以了。</p>
</blockquote>
</li>
<li>WingIDE<blockquote>
<p>Pycharm香</p>
</blockquote>
</li>
<li>flash</li>
</ul>
<h3 id="那些变了的网站"><a href="#那些变了的网站" class="headerlink" title="那些变了的网站"></a>那些变了的网站</h3><blockquote>
<p>生活不易</p>
</blockquote>
<ul>
<li>伯乐在线竟然改成了财经网站？</li>
<li>api之家：<a target="_blank" rel="noopener" href="http://www.apihome.cn/">http://www.apihome.cn/</a> 咋成了OneinStack的官网？</li>
<li><a target="_blank" rel="noopener" href="http://jm.taobao.org/">http://jm.taobao.org/</a> 这个还在更新吗？</li>
<li>乌云</li>
<li>百度云盘：由于产品的升级与调整，个人主页关闭并停止提供服务~。</li>
<li>firebug  停了好久好久了</li>
</ul>
<h3 id="那些被下架的资源"><a href="#那些被下架的资源" class="headerlink" title="那些被下架的资源"></a>那些被下架的资源</h3><ul>
<li>51CTO之前看的几本书的链接都失效了</li>
<li>淘宝收藏的几个卖小号的链接也都没用了</li>
</ul>
<h3 id="某些资源聚合站"><a href="#某些资源聚合站" class="headerlink" title="某些资源聚合站"></a>某些资源聚合站</h3><blockquote>
<p>收藏了很多很杂的东西，现在看起来，其实没啥卵用，如果一个东西你不去用起来的话，学习效率很低不说，很快就忘了。根本没必要收藏这些乱七八糟的东西，等用的时候搜索就好了</p>
</blockquote>
<ul>
<li>比如书册网、实验楼</li>
</ul>
<h3 id="不明所以"><a href="#不明所以" class="headerlink" title="不明所以"></a>不明所以</h3><blockquote>
<p>收藏的目的已经想不起来了，而且现在看起来卵用没有</p>
</blockquote>
<ul>
<li>几个搜狗微信的公众号的链接。。。</li>
<li>几个知乎的问题</li>
</ul>
<h1 id="吐槽一下"><a href="#吐槽一下" class="headerlink" title="吐槽一下"></a>吐槽一下</h1><ul>
<li>CSDN<blockquote>
<p>曾经真的以为是国内最大的技术博客网站。后来发现里面好多乱七八糟的文章（格式乱）。而且好多从别的站爬过来的文章。还有，啥时候CSDN能改下UI，不难看吗？？？</p>
</blockquote>
</li>
<li>百度云盘<blockquote>
<p>竟然有个内容商城：<a target="_blank" rel="noopener" href="https://pan.baidu.com/mall/home?from=panhome">https://pan.baidu.com/mall/home?from=panhome</a> 是在下孤陋寡闻了</p>
</blockquote>
</li>
</ul>
<h1 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h1><p>收藏应该是收藏那些值得收藏的东西，并且当以后用到的时候可以很快触达。</p>
<p>那些可以被搜索引擎替代的东西，就不要来占空间了。附：<a target="_blank" rel="noopener" href="https://www.zhihu.com/question/20161362">如何用好搜索引擎</a></p>
<p>还是自己写的笔记印象会更深刻一些。自己的笔记，可以按照自己的思维方式把资源重新整合，以后翻查也可以更快的唤起记忆。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.dytttf.com/2020/06/25/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%A4%B1%E8%B4%A5%E7%9A%84K8S%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dytttf">
      <meta itemprop="description" content="https://github.com/dytttf">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dytttf's Space">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/06/25/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%A4%B1%E8%B4%A5%E7%9A%84K8S%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/" class="post-title-link" itemprop="url">记一次失败的K8S安装部署</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-06-25 21:22:07" itemprop="dateCreated datePublished" datetime="2020-06-25T21:22:07+08:00">2020-06-25</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>某日，准备良久后，开始入K8S的坑。以下经历，惨不忍睹。</p>
<h2 id="K8S-安装"><a href="#K8S-安装" class="headerlink" title="K8S 安装"></a>K8S 安装</h2><p>K8S官方安装方式比较繁琐，有大神出了一键部署包。<a target="_blank" rel="noopener" href="https://github.com/fanux/sealos%E3%80%82">https://github.com/fanux/sealos。</a></p>
<p>安装最新版的K8S免费且简单。想安装其他版本的话，就收费了。离线安装包50一位。</p>
<p>想着自己只是测试，然后客户那边是v1.17。我装个v1.18的应该没啥问题，于是就直接开搞。安装无比顺利，两台机器，master是自己的开发机：ubuntu18.04。node新开了一台centos7.4。（当时没多想，后来坑死了）</p>
<h2 id="服务部署"><a href="#服务部署" class="headerlink" title="服务部署"></a>服务部署</h2><p>应用很简单。前后端两个Deployment、前后端各一个Service, 主要为了能在外部访问。<br>前期不太熟悉Service的部署方式，略微耗费了点时间，也还好，没啥大问题。</p>
<p>然后开心的启动服务，一切正常。 然后扭头搞别的事情去了。</p>
<h2 id="问题出现"><a href="#问题出现" class="headerlink" title="问题出现"></a>问题出现</h2><p>过了大概1个小时？突然发现服务访问不了了。在Service里配置了使用NodePort的方式，因此正常情况下我可以用任意一台node或master的IP来访问服务，但现在的情况是master可以，node不行。</p>
<p>一番苦思冥想，各种测试，外加谷歌大法，终于找到了个大神的文章：<a target="_blank" rel="noopener" href="http://www.mydlq.club/article/78/%E3%80%82">http://www.mydlq.club/article/78/。</a></p>
<p>恍然大悟，原来是v1.18的版本太新了，需要升级linux内核才能匹配。不过升级内核太麻烦，干脆换系统吧。于是一顿操作把node节点系统换成了centos8.1。这下内核版本没问题了，重启服务，发现两个节点访问都没问题。</p>
<p>很开心。</p>
<h2 id="新的问题"><a href="#新的问题" class="headerlink" title="新的问题"></a>新的问题</h2><p>过了30秒吧，突然发现master节点的服务不能访问了。node节点的访问也会报500。</p>
<p>进入pod中发现无法访问master的ip，无法访问任何外网。</p>
<p>于是又开始了疯狂DEBUG, 1个小时后。。。</p>
<p>会不会是因为master和node的系统不一致？？？</p>
<p>于是一通操作，将node改成ubuntu18.04，重启服务。测试、等待、测试、等待。</p>
<p>终于，没问题了。</p>
<h2 id="心情是这样的"><a href="#心情是这样的" class="headerlink" title="心情是这样的"></a>心情是这样的</h2><p>欲哭无泪，没 人 说 节 点 的 系 统 必 须 得 一 致 吧！！！</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.dytttf.com/2020/05/31/HTTP%E7%8A%B6%E6%80%81%E7%A0%81%E4%B8%8E%E7%88%AC%E8%99%AB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dytttf">
      <meta itemprop="description" content="https://github.com/dytttf">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dytttf's Space">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/05/31/HTTP%E7%8A%B6%E6%80%81%E7%A0%81%E4%B8%8E%E7%88%AC%E8%99%AB/" class="post-title-link" itemprop="url">HTTP状态码与爬虫</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-05-31 22:51:12" itemprop="dateCreated datePublished" datetime="2020-05-31T22:51:12+08:00">2020-05-31</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>99%的网络爬虫技术都要与HTTP协议打交道，而在打交道的过程中，你会发现很多好玩的事情。本文主要介绍那些常用的HTTP状态码是如何被反爬虫技术使用的。</p>
<h1 id="常用状态码与反爬虫"><a href="#常用状态码与反爬虫" class="headerlink" title="常用状态码与反爬虫"></a>常用状态码与反爬虫</h1><h2 id="2xx"><a href="#2xx" class="headerlink" title="2xx"></a>2xx</h2><p>2xx系列状态码一般代表响应成功。</p>
<h3 id="200"><a href="#200" class="headerlink" title="200"></a>200</h3><blockquote>
<p>OK</p>
</blockquote>
<p>最常见的状态码，代表一切正常。</p>
<h3 id="202"><a href="#202" class="headerlink" title="202"></a>202</h3><blockquote>
<p>Accepted</p>
</blockquote>
<p>这个并不常见。原意为请求已经收到，不过服务端采用了异步处理的方式在处理，所以结果没有返回给你。</p>
<h3 id="206"><a href="#206" class="headerlink" title="206"></a>206</h3><blockquote>
<p>Partial Content</p>
</blockquote>
<p>当你访问的资源支持断点下载,并且你使用了<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Range">Range</a>头部的时候,服务端会返回206，然后你可以继续换下一个范围获取之后的数据。</p>
<h2 id="3xx"><a href="#3xx" class="headerlink" title="3xx"></a>3xx</h2><p>资源重定向。需要根据返回头信息中的Location字段重新发起请求。</p>
<h3 id="301"><a href="#301" class="headerlink" title="301"></a>301</h3><blockquote>
<p>Moved Permanently</p>
</blockquote>
<p>资源 <strong>永久</strong> 重定向。注意是<strong>永久</strong>。最常见的比如网站升级了HTTPS，则当你使用HTTP访问的时候，会自动重定向到HTTPS的地址。</p>
<h3 id="302"><a href="#302" class="headerlink" title="302"></a>302</h3><blockquote>
<p>Found</p>
</blockquote>
<p>资源 <strong>临时</strong> 重定向。此种情况下，就不要改你的书签或者访问地址了，可能过一会儿临时地址就失效了。<br>常见的情况是，某些网站首次访问会有个302跳转，进入某个中间页面做一些奇奇怪怪的操作。比如当你首次访问新浪微博的时候，会触发302跳转，通过JS添加一个访客的Cookie。</p>
<h3 id="304"><a href="#304" class="headerlink" title="304"></a>304</h3><blockquote>
<p>Not Modified</p>
</blockquote>
<p>资源没有改变。这个主要是用来优化网络流量传输的。一般我们访问某个网站时，会访问这个网站的多个页面，这些页面所使用的一些静态资源，比如CSS、JS文件等都是共用的，并且在浏览器内缓存。但为了避免服务端有更新，而客户端没有及时更新，所以每次打开一个网页，浏览器都会重新请求一下这个资源，如果资源没变，那么服务端不用返回资源内容，只要返回304就好了，然后浏览器就自动使用本地缓存。如果服务端资源内容改了，那么就返回200，同时返回新的资源内容。</p>
<h2 id="4xx"><a href="#4xx" class="headerlink" title="4xx"></a>4xx</h2><p>4xx一般代表请求有问题。</p>
<h3 id="400"><a href="#400" class="headerlink" title="400"></a>400</h3><blockquote>
<p>Bad Request</p>
</blockquote>
<p>你的请求不知道哪里出了问题。一般是参数格式不对、Cookie不对等情况。</p>
<h3 id="401"><a href="#401" class="headerlink" title="401"></a>401</h3><blockquote>
<p>Unauthorized</p>
</blockquote>
<p>没有登录。一般网站会自动跳转到登录页面。某些服务会直接在页面弹窗出登录框，比如FTP服务。</p>
<h3 id="402"><a href="#402" class="headerlink" title="402"></a>402</h3><blockquote>
<p>Payment Required</p>
</blockquote>
<p>这个一点都不常用。不过很好玩。含义是：你所访问的资源是需要付费的。这个状态码设计的不错，不过真的有人会用吗？</p>
<h3 id="403"><a href="#403" class="headerlink" title="403"></a>403</h3><blockquote>
<p>Forbidden</p>
</blockquote>
<p>禁止访问。这个大概是除了200之外，在爬虫里面最常见的了 ⊙﹏⊙∥∣°，一般就是你的IP被封了。</p>
<p>不过正常情况下，一般代表没有权限访问某个资源。</p>
<h3 id="404"><a href="#404" class="headerlink" title="404"></a>404</h3><blockquote>
<p>Not Found</p>
</blockquote>
<p>资源不见了。一般是资源失效、被删除了。某些情况下，也可能是你没权限…</p>
<h3 id="405"><a href="#405" class="headerlink" title="405"></a>405</h3><blockquote>
<p>Method Not Allowed</p>
</blockquote>
<p>请求方法不对。常见于对某个需要POST访问的资源使用了GET方法。小小提示一下：某些网站是不限制这个的，或者说做了兼容。你可以把需要POST发送的数据作为URL中的参数用GET的方式访问。</p>
<h3 id="413"><a href="#413" class="headerlink" title="413"></a>413</h3><blockquote>
<p>Payload Too Large</p>
</blockquote>
<p>请求体太长了。常见于上传文件过大的情况。</p>
<h3 id="414"><a href="#414" class="headerlink" title="414"></a>414</h3><blockquote>
<p>URI Too Long</p>
</blockquote>
<p>URL太长了。有个不成文的约定，URL长度不能超过1024。不过这个并非标准，各个网站、浏览器的实现也都不一致。所以出现这个情况一般代表你构造的URL有问题。为啥是你构造的，因为肯定是你构造的。如果不是你构造的，这个问题怎么可能被触发呢。<br>还有个特殊情况，比如新浪微博在某些情况下会返回414来逗你，让你懵逼一会。你的请求没问题，只不过是被识别到你是个爬虫了。</p>
<h3 id="418"><a href="#418" class="headerlink" title="418"></a>418</h3><blockquote>
<p>I’m a teapot</p>
</blockquote>
<p>我是个茶壶。嗯，就是逗你玩。你已经被发现了。</p>
<h3 id="429"><a href="#429" class="headerlink" title="429"></a>429</h3><blockquote>
<p>Too Many Requests</p>
</blockquote>
<p>访问太频繁了。歇一会吧（或者换个代理），你已经被发现了。</p>
<h2 id="5xx"><a href="#5xx" class="headerlink" title="5xx"></a>5xx</h2><p>5xx一般代表服务端有问题。</p>
<p>这个就不分开说了，我也没仔细研究过区别。一般是后端代码有问题，处理请求出现了错误导致的。或者是网络不通等。</p>
<p>不过，某些网站会有些迷之行为。明明是正常的请求、正常的响应，偏偏返回个501。</p>
<h1 id="总结一下"><a href="#总结一下" class="headerlink" title="总结一下"></a>总结一下</h1><p>常用状态码及其含义跟大家介绍了。</p>
<p>但是，还有个重点：<br>状态码只是规范，<strong>并非强制要求</strong>。</p>
<p>所以你会看到某些网站在状态码上搞事情。走的路多了，总会遇见鬼的。</p>
<h1 id="HTTP状态码含义全集"><a href="#HTTP状态码含义全集" class="headerlink" title="HTTP状态码含义全集"></a>HTTP状态码含义全集</h1><p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status">https://developer.mozilla.org/en-US/docs/Web/HTTP/Status</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.dytttf.com/2020/04/16/Scala%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E7%94%A8%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dytttf">
      <meta itemprop="description" content="https://github.com/dytttf">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dytttf's Space">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/04/16/Scala%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E7%94%A8%E6%B3%95/" class="post-title-link" itemprop="url">Scala正则表达式用法</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-04-16 23:12:00" itemprop="dateCreated datePublished" datetime="2020-04-16T23:12:00+08:00">2020-04-16</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>记录一下Scala中关于正则表达式的一些方法的使用，之前用惯了Python，发现差别还是挺大的。。。</p>
<h2 id="基本函数-x2F-方法使用"><a href="#基本函数-x2F-方法使用" class="headerlink" title="基本函数&#x2F;方法使用"></a>基本函数&#x2F;方法使用</h2><h3 id="正则表达式定义"><a href="#正则表达式定义" class="headerlink" title="正则表达式定义"></a>正则表达式定义</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">val pattern = &quot;\\d+&quot;.r</span><br><span class="line">// 类似于python中的 pattern = re.compile(&quot;\d+&quot;)</span><br></pre></td></tr></table></figure>
<p>还有另一种定义方式，可以为每个分组指定名称，在使用scala.util.matching.Regex.Match对象时使用（下文介绍）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">val pattern = &quot;(\\d+)-(\\d+)-(\\d+)&quot;.r(&quot;year&quot;, &quot;month&quot;, &quot;day&quot;)</span><br></pre></td></tr></table></figure>
<h3 id="各种函数"><a href="#各种函数" class="headerlink" title="各种函数"></a>各种函数</h3><h4 id="findFirstIn-vs-findFirstMatchIn"><a href="#findFirstIn-vs-findFirstMatchIn" class="headerlink" title="findFirstIn vs findFirstMatchIn"></a>findFirstIn vs findFirstMatchIn</h4><p>这两个函数都用于查找匹配上的第一个元素,区别在于返回值，findFirstIn返回:Option[String], findFirstMatchIn返回:Option[Match]</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">val pattern = &quot;\\d+&quot;.r</span><br><span class="line">val text = &quot;2020-04-16&quot;</span><br><span class="line">//output =&gt; 2020</span><br><span class="line">println(pattern.findFirstIn(text).get)</span><br></pre></td></tr></table></figure>
<h4 id="findAllIn-vs-findAllMatchIn"><a href="#findAllIn-vs-findAllMatchIn" class="headerlink" title="findAllIn vs findAllMatchIn"></a>findAllIn vs findAllMatchIn</h4><p>这两个函数都用于查找匹配上的全部元素</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">val pattern = &quot;\\d+&quot;.r</span><br><span class="line">val text = &quot;2020-04-16&quot;</span><br><span class="line">//output =&gt; List(2020, 04, 16)</span><br><span class="line">println(pattern.findAllIn(text).toList)</span><br></pre></td></tr></table></figure>
<h4 id="findPrefixOf-vs-findPrefixMatchOf"><a href="#findPrefixOf-vs-findPrefixMatchOf" class="headerlink" title="findPrefixOf vs findPrefixMatchOf"></a>findPrefixOf vs findPrefixMatchOf</h4><p>此函数用于从目标字符串开始位置开始匹配，若匹配上则返回匹配到的值，发偶咋返回None，类似Pyhton的 re.match</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">val pattern = &quot;\\d+&quot;.r</span><br><span class="line">val text = &quot;2020-04-16&quot;</span><br><span class="line">//output =&gt; 2020</span><br><span class="line">println(pattern.findPrefixOf(text).get)</span><br></pre></td></tr></table></figure>
<h4 id="replaceFirstIn-vs-replaceAllIn-vs-replaceSomeIn"><a href="#replaceFirstIn-vs-replaceAllIn-vs-replaceSomeIn" class="headerlink" title="replaceFirstIn vs replaceAllIn vs replaceSomeIn"></a>replaceFirstIn vs replaceAllIn vs replaceSomeIn</h4><p>这几个函数的作用是替换，类似python的re.sub</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">val pattern = &quot;\\d+&quot;.r</span><br><span class="line">val text = &quot;2020-01-01&quot;</span><br><span class="line">// output =&gt; xxx-01-01</span><br><span class="line">println(pattern.replaceFirstIn(text, &quot;xxx&quot;).get)</span><br><span class="line">// output =&gt; xxx-xxx-xxx</span><br><span class="line">println(pattern.replaceAllIn(text, &quot;xxx&quot;).get)</span><br><span class="line">// 根据匹配到的对象自定义函数去进行不同的替换</span><br><span class="line">// output =&gt; year-xxx-xxx</span><br><span class="line">val replace_f = (m: Match) =&gt; &#123;</span><br><span class="line">      var r = Option(&quot;&quot;)</span><br><span class="line">      m.group(1) match &#123;</span><br><span class="line">        case &quot;2020&quot; =&gt; r = Some(&quot;year&quot;)</span><br><span class="line">        case _ =&gt; r = Some(&quot;xxx&quot;)</span><br><span class="line">      &#125;</span><br><span class="line">      r</span><br><span class="line">    &#125;</span><br><span class="line">println(pattern.replaceSomeIn(text, replace_f))</span><br></pre></td></tr></table></figure>

<h3 id="关于scala-util-matching-Regex-Match"><a href="#关于scala-util-matching-Regex-Match" class="headerlink" title="关于scala.util.matching.Regex.Match"></a>关于scala.util.matching.Regex.Match</h3><p>细节参见文档。简单用法如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">val pattern = &quot;(\\d+)&quot;.r(&quot;year&quot;)</span><br><span class="line">val text = &quot;2020-01-01&quot;</span><br><span class="line">val _match = pattern.findFirstMatchIn(text).get</span><br><span class="line">// 匹配到的文本 output =&gt; 2020</span><br><span class="line">println(_match.source)</span><br><span class="line">// 匹配的起始位置 output =&gt; 0</span><br><span class="line">println(_match.start)</span><br><span class="line">// 匹配的分组 output =&gt; 2020</span><br><span class="line">println(_match.group(0))</span><br><span class="line">// 匹配的分组 output =&gt; 2020</span><br><span class="line">println(_match.group(&quot;year&quot;))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="一些不太习惯的地方"><a href="#一些不太习惯的地方" class="headerlink" title="一些不太习惯的地方"></a>一些不太习惯的地方</h3><h4 id="1"><a href="#1" class="headerlink" title="#1"></a>#1</h4><p>我以为会是： 2020</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">val text = &quot;Hello, I am Scala Regex. date:2020-01-01&quot;</span><br><span class="line">val pattern = &quot;date:(\\d+)&quot;.r</span><br><span class="line"></span><br><span class="line">// output =&gt; date:2020</span><br><span class="line">println(pattern.findFirstIn(text).get)</span><br></pre></td></tr></table></figure>
<p>所以当你想获取2020时，可以这么写</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">println(pattern.findFirstMatchIn(text).get.group(1))</span><br></pre></td></tr></table></figure>
<h4 id="2"><a href="#2" class="headerlink" title="#2"></a>#2</h4><p>总感觉这个语法很诡异。。。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">val text = &quot;Hello, I am Scala Regex. date:2020-01-01&quot;</span><br><span class="line">val pattern = &quot;.*date:(\\d+).*&quot;.r</span><br><span class="line"></span><br><span class="line">val pattern(year) = text</span><br><span class="line">// output =&gt; 2020</span><br><span class="line">println(year)</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">京ICP备2021028637号 </a>
  </div>

<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Dytttf</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  




  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




<script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"dytttf/dytttf.github.io","issue_term":"pathname","theme":"preferred-color-scheme"}</script>
<script src="/js/third-party/comments/utterances.js"></script>

</body>
</html>
